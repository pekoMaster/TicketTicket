# Zaiko Ticket Companion Matching Platform (MVP) 工作紀錄

## 需求文件（完整記錄）

### Project: Zaiko Ticket Companion Matching Platform (MVP)

### Role
Act as a Senior Full-Stack Developer. Build a mobile-first web application deployed on Vercel.

### Goal
Create a "Concert Companion Matching" platform for users holding Zaiko electronic tickets.
The core concept is NOT reselling tickets/accounts, but finding a partner to enter the venue together ("Shared Entry").
NO online payment processing. 全部 payments are settled offline (Face-to-Face).

### Tech Stack
- Framework: Next.js (App Router)
- Styling: Tailwind CSS
- Deployment: Vercel
- Icons: Lucide React
- Database/Auth (Mock for MVP): Use local state or mock data structures first. (Plan for Supabase later).

### Core Features & Requirements

1. **Ticket Listing 系統 (The Host)**
   - Create a post with fields: Event Name, Date, Venue, Meeting Time.
   - **Price Validator**: Input JPY (Original Price). 系統 must auto-convert to TWD (simulate fixed rate 0.22 for now).
   - **Constraint**: The asking price CANNOT exceed the (Original Price / Number of people). It must be a "cost-sharing" model.
   - **Ticket Type Tags**:
     - "Must Enter Together" (Host holds main ticket)
     - "Inbound/Overseas Ticket" (ID check warning)
     - "Separate Link"
   - **狀態**: Open / Matched / Closed.

2. **搜尋 & Discovery (The Guest)**
   - List view of available companion slots.
   - Filter by Date or Keyword.
   - Button: "Apply to Join" (NOT "Buy Now").

3. **Matching & Communication Flow**
   - User A (Guest) applies -> User B (Host) accepts.
   - Once matched, unlock a **Private Chat Interface**.
   - **Safety Warning**: Display a persistent banner in chat: "Host must be present for entry. Do not transfer money online. Meet at the venue."

4. **Review 系統**
   - Simple 5-star rating and comment system after the event date.

5. **Legal & Disclaimer (Critical)**
   - A modal on first visit: "This platform is for companion matching, not ticket resale. We are not responsible for entry refusal due to ID checks."

### UI/UX Design
- **Mobile-First**: Users will use this at the concert venue.
- **Trustworthy**: Clean, modern interface.
- **Visuals**: Use clear badges for "Price" and "Ticket Type".

### Output
Generate the project structure and key components for this application. Focus on the frontend flow and the logic for the "Price Validator" and "Matching Status".

語言：繁體中文

---

## 執行進度

### 階段 1：專案初始化 ✅
- [x] 建立 Next.js 專案結構
- [x] 設定 Tailwind CSS
- [x] 安裝 Lucide React
- [x] 安裝 OpenSpec (Spec-driven development)

### 階段 2：核心元件開發 ✅
- [x] 建立共用元件（Header, BottomNav, Card, Modal）
- [x] 建立票券刊登表單
- [x] 建立價格驗證器
- [x] 建立票券類型標籤
- [x] 建立 Button, Input, Avatar, StarRating 等 UI 元件
- [x] 建立 SafetyBanner 安全警告元件

### 階段 3：頁面開發 ✅
- [x] 首頁（票券列表）
- [x] 探索頁（搜尋篩選）
- [x] 票券詳情頁
- [x] 發布票券頁
- [x] 訊息管理頁（配對申請管理）
- [x] 聊天介面
- [x] 個人頁

### 階段 4：功能整合 ✅
- [x] 搜尋與篩選功能
- [x] 配對流程（申請/接受/拒絕）
- [x] 免責聲明 Modal（首次訪問檢測）
- [x] 聊天安全警告橫幅
- [x] 模擬資料整合

---

## 專案結構

```
TicketTicket/
├── openspec/                    # OpenSpec 規格文件
│   ├── specs/                   # 功能規格
│   │   ├── project/            # 專案概述
│   │   ├── data-models/        # 資料模型
│   │   ├── features/           # 功能規格
│   │   │   ├── listing-system/
│   │   │   ├── search-system/
│   │   │   ├── matching-system/
│   │   │   ├── review-system/
│   │   │   └── legal-disclaimer/
│   │   └── ui/                 # UI 規格
│   └── changes/                # 變更提案
│       └── mvp-implementation/
├── src/
│   ├── app/                    # Next.js App Router 頁面
│   │   ├── page.tsx            # 首頁
│   │   ├── explore/            # 探索頁
│   │   ├── listing/[id]/       # 刊登詳情頁
│   │   ├── create/             # 發布頁
│   │   ├── messages/           # 訊息管理頁
│   │   ├── chat/[id]/          # 聊天頁
│   │   └── profile/            # 個人頁
│   ├── components/
│   │   ├── ui/                 # 基礎 UI 元件
│   │   ├── layout/             # 佈局元件
│   │   └── features/           # 功能元件
│   ├── contexts/               # React Context
│   ├── data/                   # 模擬資料
│   └── types/                  # TypeScript 型別
└── package.json
```

---

## 更新日誌

### 2025-12-14
- 使用 OpenSpec 進行 Spec-driven development
- 建立完整的功能規格文件
- 完成 MVP 核心功能開發
- 專案編譯測試通過

---

## 啟動指令

```bash
# 開發模式
npm run dev

# 編譯
npm run build

# 啟動生產版本
npm start
```

---

## 新需求 V2（2025-12-14 追加）

### 完整需求記錄：
1. 你是如何抓票資料的，還是那是假的 → **目前是假資料(模擬)，需接 Supabase**
2. 你怎麼去儲存跟抓取資料的 → **目前用 React Context + localStorage，需改 Supabase**
3. 你怎麼做到線上訊息的 → **目前模擬，需 WebSocket/Supabase Realtime**
4. 請上設計成電腦跟手機版本能有不同顯示的模式 → **響應式設計優化**
5. 名稱的部分我想設計成選擇的 → **活動名稱改為下拉選單**
6. 能不能使用LINE登入認證? → **整合 LINE Login API**
7. 請移除所有什麼分攤帳款的公告跟訊息 → **移除分攤相關文字**
8. 整體設計必須合日本法律 → **日本法律合規調整**
9. APP剛登入時必須強制選擇語言 [繁體中文] [簡體中文] [日本語] [ENGLISH] → **強制語言選擇**
10. 所有介面會跟著切換 → **多語言系統 (i18n)**

### 執行計劃：
- [x] 建立多語言系統 (next-intl) ✅ 2025-12-14
- [x] 強制語言選擇 Modal（首次訪問）✅ 2025-12-14
- [x] 移除所有分攤帳款相關訊息 ✅ 2025-12-14
- [x] 響應式設計優化（電腦/手機不同佈局）✅ 2025-12-15
- [x] 活動名稱改為選擇式 ✅ 2025-12-15
- [x] 日本法律合規調整（特定商取引法等）✅ 2025-12-15
- [ ] LINE 登入準備（next-auth + LINE Provider）
- [ ] Supabase 資料庫整合
- [ ] 即時訊息功能

### V2 多語言實作記錄（2025-12-14）：
- 安裝 `next-intl` 套件
- 建立語言檔案：`messages/zh-TW.json`, `messages/zh-CN.json`, `messages/ja.json`, `messages/en.json`
- 建立語言配置：`src/i18n/config.ts`, `src/i18n/request.ts`
- 建立語言 Context：`src/contexts/LanguageContext.tsx`
- 建立語言選擇 Modal：`src/components/layout/LanguageModal.tsx`
- 更新 `next.config.ts` 支援 next-intl
- 更新 `layout.tsx` 加入 NextIntlClientProvider
- 更新所有頁面和元件使用 `useTranslations` hook
- 語言儲存於 localStorage 和 cookie，cookie 供 server 端使用
- 首次訪問強制選擇語言，之後顯示免責聲明
- 移除所有「分攤帳款」相關文字，改為「費用」或「價格」
- 編譯測試通過

### V2 響應式設計實作記錄（2025-12-15）：
- 建立桌面版側邊導覽：`src/components/layout/SideNav.tsx`
- 更新底部導覽：手機版顯示，桌面版隱藏 (`lg:hidden`)
- 更新 `layout.tsx`：加入 SideNav，flex 佈局，main 區塊 `lg:ml-64`
- 更新 `Header.tsx`：桌面版偏移 `lg:left-64`
- 更新首頁：桌面版 grid 2-3 欄佈局
- 更新探索頁：桌面版 grid 佈局
- 更新訊息頁：桌面版 grid 佈局
- 更新個人頁：桌面版 grid 佈局
- 更新發布頁：底部按鈕偏移 `lg:left-64 lg:bottom-0`
- 更新詳情頁：底部按鈕偏移 `lg:left-64 lg:bottom-0`
- 編譯測試通過

### V2 活動名稱選擇式實作記錄（2025-12-15）：
- 建立活動資料檔：`src/data/events.ts`
- 包含 40+ 熱門日本音樂活動（J-POP、偶像團體、VTuber、音樂祭）
- 建立可搜尋選擇元件：`src/components/ui/Select.tsx`
- 支援搜尋篩選、自訂輸入選項
- 更新發布頁使用下拉選單選擇活動
- 加入多語言翻譯「其他活動（自行輸入）」
- 編譯測試通過

### V2 日本法律合規調整實作記錄（2025-12-15）：
- 建立法律頁腳元件：`src/components/layout/LegalFooter.tsx`
- 建立特定商取引法公示頁：`src/app/legal/tokushoho/page.tsx`
- 加入四語言法律翻譯（legal, tokushoho）
- 包含：事業者名稱、負責人、服務內容、費用、支付方式、退費規定、重要聲明
- 更新 Profile 頁面加入法律連結（特定商取引法表示）
- 符合日本特定商取引法要求
- 編譯測試通過

### V2 應用內語言切換功能（2025-12-15）：
- 建立語言切換元件：`src/components/ui/LanguageSwitcher.tsx`
- 支援兩種顯示模式：button（按鈕）、menu-item（選單項）
- 國旗 + 語言名稱顯示
- 點擊彈出語言選擇 Modal
- Profile 頁面設定選單加入語言切換
- 桌面版 SideNav 底部加入語言切換按鈕
- 編譯測試通過

### V2 HOLOLIVE 活動管理系統（2025-12-15）：
- 建立活動型別定義：`src/types/index.ts` 新增 `HololiveEvent`、`EventCategory`
- 建立管理員 Context：`src/contexts/AdminContext.tsx`
  - 活動 CRUD 操作（新增、編輯、刪除）
  - 簡易密碼驗證（預設密碼：hololive2025）
  - localStorage 資料持久化
  - 預設 8 個 HOLOLIVE 活動
- 建立管理員佈局：`src/app/admin/layout.tsx`
  - 深色主題 Header
  - 密碼登入介面
  - 登出功能
- 建立活動管理頁面：
  - `/admin/events` - 活動列表（搜尋、篩選、顯示/隱藏切換）
  - `/admin/events/new` - 新增活動
  - `/admin/events/[id]` - 編輯活動
- 建立活動表單元件：`src/components/admin/EventForm.tsx`
  - 完整欄位：名稱、藝人、日期、場地、票價、連結等
  - 分類選擇（演唱會、粉絲見面會、展覽、線上直播、其他）
  - 表單驗證
- 更新 `src/data/events.ts` 改為 HOLOLIVE 專用清單
  - 包含 50+ HOLOLIVE 相關活動
  - JP / EN / ID / HOLOSTARS 全覆蓋
- 編譯測試通過

---

## 新需求 V3（2025-12-15 追加）

### 完整需求記錄：

**票務資訊調整：**
1. 座位等級：B > A > S > SS
2. 票種類型：一人、二人、家庭(Family)
3. 移除開賣時間和截止時間（同行系統不需要）

**功能補充：**
7. 必須寫上當天自己的穿著或者是顯眼可辨識的特徵
8. 日期、集合地點（已存在）
9. 非商用且不收任何手續費用聲明
10. 必須寫上持有票人的國籍、可使用語言
11. 主辦人額外需求（主辦人為女性，只想找同行者女性）
12. 加入，此頁面僅服務vtuber粉絲，無任何手續費，但不介意以後開放斗內
13. 加入一些基本的禁詞表

### V3 實作記錄（2025-12-15）：

**型別更新** (`src/types/index.ts`)：
- 新增 `SeatGrade`：B / A / S / SS
- 新增 `TicketCountType`：solo / duo / family
- 新增 `Gender`：male / female / other / any
- 擴充 `Listing` 介面：
  - `seatGrade` 座位等級
  - `ticketCountType` 票種類型
  - `hostNationality` 主辦人國籍
  - `hostLanguages` 可使用語言（陣列）
  - `identificationFeatures` 辨識特徵
  - `hostGender` 主辦人性別
  - `preferredGender` 希望同行者性別
- 新增常數：`SEAT_GRADE_INFO`、`TICKET_COUNT_TYPE_INFO`、`GENDER_INFO`
- 新增選項：`NATIONALITY_OPTIONS`（14個國籍）、`LANGUAGE_OPTIONS`（8種語言）

**發布表單更新** (`src/app/create/page.tsx`)：
- 座位等級選擇（B/A/S/SS 按鈕組）
- 票種類型選擇（一人/二人/家庭 按鈕組）
- 國籍下拉選單
- 語言多選按鈕組
- 主辦人性別選擇
- 希望同行者性別選擇
- 辨識特徵輸入（必填）

**免責聲明更新** (`src/components/layout/DisclaimerModal.tsx`)：
- 新增「VTuber 粉絲專屬平台」區塊（粉色背景）
- 新增「非商用・零手續費」區塊（綠色背景）
- 四語言翻譯更新

**禁詞過濾** (`src/utils/contentFilter.ts`)：
- 建立禁詞列表（約炮/詐騙/黃牛/不當言論）
- 支援中/英/日多語言
- 提供函數：`containsBannedWords`、`findBannedWords`、`censorBannedWords`、`validateContent`

**模擬資料更新** (`src/data/mock.ts`)：
- 改為 HOLOLIVE 主題
- 所有 Listing 加入新欄位

編譯測試通過

### V3 開賣時間/售票截止欄位移除（2025-12-15）：

已從以下檔案移除 `ticketSaleStart` 和 `ticketSaleEnd` 欄位：
- `src/types/index.ts` - HololiveEvent 介面
- `src/components/admin/EventForm.tsx` - 表單資料狀態與提交處理
- `src/contexts/AdminContext.tsx` - 預設活動資料與解析函數

編譯測試通過

---

## 待辦事項（MVP 後續）

- [x] HOLOLIVE 活動管理系統 ✅
- [x] 評價系統功能 ✅ 2025-12-17
- [x] 完整的用戶檔案頁 ✅ 2025-12-17
- [x] 頁尾法律連結 ✅ 2025-12-17
- [x] Vercel 部署 ✅
- [x] Supabase 資料庫整合 ✅
- [x] Google OAuth 登入整合 ✅

**所有 MVP 後續工作項目已完成！**

---

## 新需求 V4（2025-12-17 追加）

### 完整需求記錄：

**登入系統調整：**
1. 只開放 GOOGLE 登入（移除 LINE、Discord 登入按鈕）
2. 訪客如要申請、開活動、進入個人頁面，都會跳轉登入頁

**個人設定頁面功能：**
1. 名稱更改功能
2. 頭像上傳更改功能
3. 手機電話（含國碼選擇）- 選填，告知非必要但可讓對方在需要時聯絡
4. 連結帳號功能：
   - LINE ID 連結
   - Discord ID 連結
   - 這兩個會顯示在活動發起人的頁面（僅 ICON）
   - 只有申請活動後才能看見
   - 可在個人設定中決定是否顯示

### 執行計劃：
- [x] 登入頁面只保留 Google 登入 ✅ 2025-12-17
- [x] 個人設定：名稱更改功能 ✅ 2025-12-17
- [x] 個人設定：頭像上傳更改功能 ✅ 2025-12-17
- [x] 個人設定：手機電話（含國碼）選填 ✅ 2025-12-17
- [x] 個人設定：LINE/Discord 連結帳號與顯示控制 ✅ 2025-12-17
- [x] 更新資料庫 schema 加入新欄位 ✅ 2025-12-17
- [x] 建立個人資料更新 API ✅ 2025-12-17
- [x] 活動發起人頁面顯示 LINE/Discord icon（僅申請後可見）✅ 2025-12-17

### V4 實作記錄（2025-12-17）：

**登入頁面更新** (`src/app/login/page.tsx`)：
- 移除 LINE 和 Discord 登入按鈕
- 只保留 Google 登入，使用彩色 Google 圖示

**資料庫 Schema 更新** (`supabase/schema.sql`, `supabase/add-user-profile-fields.sql`)：
- 新增 `custom_avatar_url` 欄位（用戶上傳的自訂頭像）
- 新增 `phone_country_code` 和 `phone_number` 欄位
- 新增 `line_id` 和 `discord_id` 欄位
- 新增 `show_line` 和 `show_discord` 欄位（控制是否顯示在主辦頁面）
- 新增電話索引

**類型更新** (`src/types/index.ts`)：
- User 介面新增：customAvatarUrl, phoneCountryCode, phoneNumber, lineId, discordId, showLine, showDiscord
- 新增 PHONE_COUNTRY_CODES 常數（13 個常用國碼）

**API 路由**：
- `src/app/api/profile/route.ts` - GET/PATCH 用戶資料
- `src/app/api/profile/avatar/route.ts` - POST 上傳頭像 / DELETE 移除頭像

**個人設定頁面** (`src/app/profile/settings/page.tsx`)：
- 頭像上傳/更換功能（支援 Supabase Storage 或 data URL）
- 顯示名稱修改
- 手機電話（含國碼下拉選單）
- LINE ID / Discord ID 連結
- 顯示控制開關（是否在主辦頁面顯示）

**翻譯更新** (`messages/*.json`)：
- 新增 profileSettings 區塊，包含所有設定頁面文字
- 支援繁體中文、簡體中文、日文、英文

**刊登詳情頁更新** (`src/app/listing/[id]/page.tsx`)：
- 主辦方區塊新增 LINE/Discord 圖示顯示
- 僅在用戶已申請後才顯示（hasApplied = true）
- 顯示條件：host.showLine 或 host.showDiscord 為 true

**Context 更新** (`src/contexts/AppContext.tsx`)：
- ApiUser 介面新增新欄位
- convertApiListingToListing 函數新增欄位轉換

**Listings API 更新** (`src/app/api/listings/route.ts`)：
- 查詢時包含 host 的新欄位

編譯測試通過

---

## 新需求 V5（2025-12-17 追加）

### 即時訊息功能

**使用 Supabase Realtime 實作即時聊天**

### 執行計劃：
- [x] 啟用 Supabase Realtime 功能 ✅ 2025-12-17
- [x] 建立前端 Supabase 客戶端 ✅ 2025-12-17
- [x] 更新聊天頁面支援即時訊息 ✅ 2025-12-17

### V5 實作記錄（2025-12-17）：

**SQL 腳本** (`supabase/enable-realtime.sql`)：
- 啟用 messages 表的 Realtime 功能
- `ALTER PUBLICATION supabase_realtime ADD TABLE messages;`

**前端 Hook** (`src/hooks/useSupabaseClient.ts`)：
- 建立前端專用的 Supabase 客戶端 hook
- 配置 Realtime 參數

**聊天頁面更新** (`src/app/chat/[id]/page.tsx`)：
- 移除 5 秒輪詢機制
- 改用 Supabase Realtime 訂閱 postgres_changes
- 監聯 INSERT 事件，即時收到新訊息
- 樂觀更新：發送訊息立即顯示，不等 API 回應
- 發送失敗時自動移除臨時訊息

編譯測試通過

---

## 新需求 V6（2025-12-17 追加）

### 完成所有剩餘工作項目

### 執行計劃：
- [x] 評價系統功能 ✅ 2025-12-17
- [x] 完整的用戶檔案頁 ✅ 2025-12-17
- [x] 頁尾法律連結 ✅ 2025-12-17

### V6 實作記錄（2025-12-17）：

**評價系統 API** (`src/app/api/reviews/`)：
- `route.ts` - GET: 取得用戶收到的評價列表；POST: 建立新評價
- `can-review/[listingId]/route.ts` - 檢查用戶是否可以評價此刊登
- 評價條件：活動日期已過、申請已被接受、尚未評價過
- 主辦方可評價被接受的申請者，申請者可評價主辦方

**評價系統 UI 元件**：
- `ReviewCard.tsx` - 評價卡片元件，顯示評價者、評分、評論
- `ReviewModal.tsx` - 評價彈窗，支援選擇評價對象、星級評分、評論

**刊登詳情頁更新** (`src/app/listing/[id]/page.tsx`)：
- 新增評價功能：活動結束後顯示評價按鈕
- 自動檢查是否可以評價
- 整合 ReviewModal 元件

**個人檔案頁更新** (`src/app/profile/page.tsx`)：
- 從 API 取得用戶資料和評價
- 新增「收到的評價」區塊
- 顯示用戶頭像（支援自訂頭像）
- 正確顯示評分和評價數

**翻譯更新** (`messages/*.json`)：
- 新增 `review` 區塊，包含所有評價相關翻譯
- 支援繁體中文、簡體中文、日文、英文

**頁尾法律連結** (`src/components/layout/MainLayout.tsx`)：
- 整合 LegalFooter 元件
- 桌面版顯示，行動版透過個人頁面設定存取

編譯測試通過

---

## Bug Fix: 管理員活動不顯示問題（2025-12-17）

### 問題描述
管理員建立的活動無法在前台顯示

### 原因
- Supabase RLS (Row Level Security) 限制
- events 表只允許查看 `is_active = true` 的活動
- INSERT/UPDATE/DELETE 操作需要繞過 RLS

### 解決方案

**更新 Supabase 客戶端** (`src/lib/supabase.ts`)：
- 新增 `supabaseAdmin` 客戶端，使用 `SUPABASE_SERVICE_ROLE_KEY` 繞過 RLS
- 一般操作使用 `supabase`（anon key）
- 管理員操作使用 `supabaseAdmin`（service role key）

**更新 Events API**：
- `GET /api/events`：帶 `includeInactive=true` 時使用 admin client
- `POST /api/events`：使用 admin client
- `PATCH /api/events/[id]`：使用 admin client
- `DELETE /api/events/[id]`：使用 admin client

### 需要的環境變數
```
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
```

可在 Supabase Dashboard → Settings → API 取得 service_role 金鑰

編譯測試通過

---

## 新需求 V7（2025-12-18 追加）

### 用戶編輯/移除自己的刊登功能

**需求描述：**
用戶需要能夠編輯或移除自己發布的刊登

### V7 實作記錄（2025-12-18）：

**AppContext 更新** (`src/contexts/AppContext.tsx`)：
- 新增 `deleteListing` 函數，呼叫 DELETE API 刪除刊登
- 更新 `updateListing` 函數回傳 `Promise<boolean>`

**刊登詳情頁更新** (`src/app/listing/[id]/page.tsx`)：
- 新增主辦方管理選單（三點選單）
- 編輯功能：跳轉至編輯頁面
- 更改狀態功能：選擇 開放中/已配對/已關閉
- 刪除功能：確認彈窗，刪除後跳轉個人頁面

**新增編輯頁面** (`src/app/listing/[id]/edit/page.tsx`)：
- 載入現有刊登資料並填入表單
- 檢查是否為擁有者，非擁有者顯示錯誤
- 表單驗證與提交更新
- 更新成功後跳轉回刊登詳情頁

**翻譯更新** (`messages/*.json`)：
- 在 `listing` 區塊新增：
  - `edit`, `delete`, `changeStatus`
  - `deleteConfirmTitle`, `deleteConfirmMessage`
  - `deleting`, `updating`
  - `statusOpen`, `statusMatched`, `statusClosed`
- 新增 `edit` 區塊：
  - `title`, `updateSuccess`, `updateRedirecting`
  - `update`, `loadingError`, `notFound`
- 支援繁體中文、簡體中文、日文、英文

編譯測試通過

---

## 新需求 V8（2025-12-18 追加）

### 首頁搜索與過濾系統

**需求描述：**
首頁搜索過濾系統，像那種購物電商那種功能，可以很多種過濾
- 模糊關鍵字搜尋(input)
- 活動過濾(下拉式)
- 活動日期區間過濾(選擇)
- 票種類型過濾(下拉式)
- 票券等級(下拉式)
- 價格過濾(兩個輸入框，最低到最高)
- 使用者名稱(input，模糊)
- 評分(下拉式)
- 國籍(下拉式)
- 語言(多選checkbox)
- 把近期活動那個區塊移除

### V8 首頁搜索過濾實作記錄（2025-12-18）：

**首頁更新** (`src/app/page.tsx`)：
- 移除「近期活動」區塊
- 新增完整搜索過濾系統
- 模糊關鍵字搜尋
- 活動下拉式篩選
- 日期範圍篩選（全部/一週內/一個月內/三個月內）
- 票券類型篩選
- 價格範圍篩選（最低/最高）
- 主辦人名稱模糊搜尋
- 最低評分篩選
- 國籍篩選
- 語言多選篩選
- 排序選項（日期/價格/評分）
- 一鍵清除所有篩選

**翻譯更新** (`messages/*.json`)：
- 新增 `filter` 區塊，包含所有過濾相關翻譯
- 支援繁體中文、簡體中文、日文、英文

編譯測試通過

---

## 新需求 V9（2025-12-18 追加）

### 完整需求記錄：

1. 管理員新增的票種等級從下拉式改成輸入框
2. 承上，使用者在選擇票種等級的時候則依照相同名稱的同一按鈕類別，不同名稱的就自動有第二個按鈕
3. 使用者的刊登類型沒有其他語言的翻譯請補上
4. 使用者的刊登類型增加一個叫做換票
5. 一旦選擇換票，就會多出一個欄位要選擇想換的內容:
   - 活動
   - 票種等級(除了既有的設定票種以外額外會有一個任意)
6. 如果選擇換票，希望價格的欄位會隱藏，會有新的欄位
   - 補貼價格（輸入框、不得超過該票券設定票種價格的的一半）
   - 補貼設定 (下拉式，我補貼你、還是你補貼我)
7. 同行集合地點 改名稱為 同行集合地點(線上交換請直接寫線上)
8. 全部完成後檢查所有介面，以中文的介面為準去尋找還有沒有沒翻譯到的文字
9. 全部寫完後，將母票轉讓的功能暫時灰掉不給選擇
10. spec coding

### 執行計劃：
- [x] 管理員票種等級改為輸入框
- [x] 使用者票種等級動態按鈕顯示
- [x] 刊登類型多語言翻譯補充
- [x] 新增換票刊登類型
- [x] 換票欄位邏輯實作
- [x] 同行集合地點改名
- [x] 母票轉讓灰掉禁用
- [x] 測試並部署

### V9 實作記錄（2025-12-18）：

**類型定義更新** (`src/types/index.ts`)：
- `SeatGrade` 從固定值改為動態字串 `string`
- 新增 `ticket_exchange` 票券類型
- 新增 `SubsidyDirection` 類型（'i_pay_you' | 'you_pay_me'）
- `Listing` 介面新增換票欄位：
  - `exchangeEventName`: 想換的活動名稱
  - `exchangeSeatGrade`: 想換的座位等級
  - `subsidyAmount`: 補貼金額
  - `subsidyDirection`: 補貼方向
- `TICKET_TYPE_INFO` 新增 `disabled` 屬性（母票轉讓暫停用）
- 新增 `getSeatGradeLabel()` 和 `getSeatGradeColor()` 函數

**管理員活動表單** (`src/components/admin/EventForm.tsx`)：
- 座位等級從下拉式選單改為輸入框
- 管理員可自訂任意座位等級名稱
- 更新驗證邏輯確保座位等級名稱不為空

**發布頁面** (`src/app/create/page.tsx`)：
- 座位等級改為動態按鈕（根據活動設定自動生成）
- 新增換票類型選項和相關UI
- 換票模式下隱藏價格欄位，顯示：
  - 想換的活動（下拉選擇）
  - 想換的票種等級（動態按鈕 + 任意選項）
  - 補貼金額（限制為票價一半）
  - 補貼方向（我補貼對方/對方補貼我）
- 母票轉讓選項灰掉並顯示「即將開放」標籤
- 同行集合地點標籤改為「同行集合地點（線上交換請直接寫線上）」

**探索頁面** (`src/app/explore/page.tsx`)：
- 新增 ticket_exchange 類型支援

**標籤元件** (`src/components/ui/Tag.tsx`)：
- 新增 ticket_exchange 類型和對應的橘色樣式

**AppContext** (`src/contexts/AppContext.tsx`)：
- 更新 `ApiListing` 介面支援換票欄位
- 更新 `CreateListingData` 介面支援換票欄位
- 轉換函數包含換票欄位

**API 路由** (`src/app/api/listings/route.ts`)：
- POST 路由支援換票相關欄位儲存

**翻譯更新** (`messages/*.json`)：
- 新增 `create.ticketTypes` 區塊（四種語言完整翻譯）
- 新增換票相關翻譯鍵：
  - `exchangeSection`, `exchangeEvent`, `selectExchangeEvent`
  - `exchangeSeatGrade`, `anyGrade`
  - `subsidyAmount`, `subsidyAmountPlaceholder`, `subsidyAmountHint`
  - `subsidyDirection`, `iPayYou`, `youPayMe`
  - `meetingPointWithHint`
- 新增 `ticketType.ticketExchange` 相關翻譯
- 新增 `comingSoon` 翻譯

編譯測試通過

### V9 後續優化（2025-12-18）：

**資料庫 Schema 更新** (`supabase/add-exchange-fields.sql`)：
- 新增 `exchange_event_name` 欄位（想換的活動名稱）
- 新增 `exchange_seat_grade` 欄位（想換的座位等級）
- 新增 `subsidy_amount` 欄位（補貼金額）
- 新增 `subsidy_direction` 欄位（補貼方向）
- 擴充 `seat_grade` 欄位為 VARCHAR(50) 支援自訂名稱
- 新增 `ticket_type` 索引

**刊登詳情頁更新** (`src/app/listing/[id]/page.tsx`)：
- 新增換票資訊顯示區塊（想換活動、票種、補貼資訊）
- 新增零手續費聲明區塊（綠色背景，Shield 圖示）
- 更新 getTicketTypeInfo 支援 ticket_exchange 類型

**翻譯更新** (`messages/*.json`)：
- 新增 `listing.exchangeInfo`、`wantToExchange`、`wantSeatGrade`、`subsidyInfo`、`myTicketPrice`
- 新增 `listing.noFeeTitle`、`noFeeDesc`（零手續費聲明）
- 新增 `common.publishFailed`、`applyFailed`、`deleteFailed`、`updateFailed`
- 新增 `common.defaultUser`、`inputMessage`、`chatWith`、`chat`
- 四語言完整翻譯（繁中/簡中/英文/日文）

**程式碼翻譯化**：
- `create/page.tsx` - alert 錯誤訊息改用翻譯
- `listing/[id]/page.tsx` - alert 錯誤訊息改用翻譯
- `listing/[id]/edit/page.tsx` - alert 錯誤訊息改用翻譯
- `chat/[id]/page.tsx` - 標題和 placeholder 改用翻譯
- `profile/page.tsx` - 預設用戶名改用翻譯

編譯測試通過

---

## 部署步驟：Supabase 資料庫更新

### 執行換票欄位 Migration

**步驟 1：登入 Supabase Dashboard**
1. 前往 https://supabase.com/dashboard
2. 選擇你的專案

**步驟 2：開啟 SQL Editor**
1. 左側選單點擊 **SQL Editor**
2. 點擊 **+ New query** 建立新查詢

**步驟 3：貼上並執行以下 SQL**

```sql
-- Add exchange-related fields to listings table for V9 ticket exchange feature
-- Run this migration to add support for ticket exchange listings

-- Add exchange event name (the event user wants to exchange for)
ALTER TABLE listings ADD COLUMN IF NOT EXISTS exchange_event_name VARCHAR(255);

-- Add exchange seat grade (the seat grade user wants, or 'any')
ALTER TABLE listings ADD COLUMN IF NOT EXISTS exchange_seat_grade VARCHAR(50);

-- Add subsidy amount (max half of original ticket price)
ALTER TABLE listings ADD COLUMN IF NOT EXISTS subsidy_amount INTEGER DEFAULT 0;

-- Add subsidy direction ('i_pay_you' or 'you_pay_me')
ALTER TABLE listings ADD COLUMN IF NOT EXISTS subsidy_direction VARCHAR(20);

-- Update ticket_type column comment to include new type
COMMENT ON COLUMN listings.ticket_type IS 'Ticket type: find_companion, main_ticket_transfer, sub_ticket_transfer, ticket_exchange';

-- Update seat_grade column to allow any string (not just B/A/S/SS)
-- Already VARCHAR(10), but let's expand it for custom grades
ALTER TABLE listings ALTER COLUMN seat_grade TYPE VARCHAR(50);

-- Add index for ticket_type to improve filtering performance
CREATE INDEX IF NOT EXISTS idx_listings_ticket_type ON listings(ticket_type);
```

**步驟 4：執行查詢**
1. 點擊右下角的 **Run** 按鈕（或按 Ctrl+Enter）
2. 確認執行成功，應該會看到 "Success. No rows returned"

**步驟 5：驗證欄位已新增**
在 SQL Editor 執行以下查詢確認：
```sql
SELECT column_name, data_type, character_maximum_length
FROM information_schema.columns
WHERE table_name = 'listings'
AND column_name IN ('exchange_event_name', 'exchange_seat_grade', 'subsidy_amount', 'subsidy_direction', 'seat_grade');
```

應該會看到 5 筆結果，確認欄位已成功建立。

---

## 新需求 V10（2025-12-19 追加）

### 完整需求記錄：

1. 由於首頁的過濾功能很完整，直接移除整個探索頁面跟功能，記得要調整UI，包含所有平台
2. 個人自己發布的活動到現在依然不能編輯跟移除，請將這兩個功能跟管理申請並列
   - [管理申請][編輯活動][移除活動]
3. 點擊編輯活動的時候要警告編輯活動完畢會移除所有申請人，同時被移除申請活動的申請人會在消息那邊收到通知
4. 已經確認要跟誰處理交換的就不能編輯
5. 連結帳號的兩個應該要像其他網站一樣真的連接，點擊後會跳到認證網頁這樣才對
6. 個人資料那邊不只有我的刊登，還要有我的申請，這個申請可以移除
7. 提供所有介面的 日、夜網頁風格

### 執行計劃：
- [x] 移除探索頁面和相關導航 ✅ 2025-12-19
- [x] 更新所有導航元件（底部導航、側邊導航）✅ 2025-12-19
- [x] 個人刊登頁面新增 [管理申請][編輯活動][移除活動] 按鈕 ✅ 2025-12-19
- [x] 編輯活動警告機制（會移除所有申請人）✅ 2025-12-19
- [x] 申請人被移除時發送通知（需先執行 notifications 資料表 SQL）✅ 2025-12-19
- [x] 已配對的刊登禁止編輯 ✅ 2025-12-19
- [x] 個人資料新增「我的申請」區塊 ✅ 2025-12-19
- [x] 申請可移除功能 ✅ 2025-12-19
- [x] 深色/淺色主題切換功能 ✅ 2025-12-19
- [x] 更新所有翻譯（zh-TW, zh-CN, en, ja）✅ 2025-12-19
- [x] LINE/Discord OAuth 真實連結認證 ✅ 2025-12-19

### V10 實作記錄（2025-12-19）：

**已刪除檔案：**
- `src/app/explore/` - 移除整個探索頁面

**已更新檔案：**
- `src/components/layout/BottomNav.tsx` - 移除探索導航項目
- `src/components/layout/SideNav.tsx` - 移除探索導航項目
- `src/app/layout.tsx` - 添加 ThemeProvider，深色模式支援
- `src/app/globals.css` - 添加深色模式 CSS 變數和 @custom-variant

**新增檔案：**
- `src/contexts/ThemeContext.tsx` - 主題切換 Context
- `src/components/ui/ThemeSwitcher.tsx` - 主題切換元件
- `supabase/add-notifications-table.sql` - 通知資料表 SQL

**大幅更新檔案：**
- `src/app/profile/page.tsx` - 新增：
  - 我的申請區塊（顯示所有已申請的刊登）
  - 申請撤回功能（pending 狀態可撤回）
  - 刊登管理按鈕（[管理申請][編輯活動][移除活動]）
  - 主題切換入口
  - 深色模式支援

- `src/app/listing/[id]/edit/page.tsx` - 新增：
  - 編輯警告 Modal（提醒會移除所有申請人）
  - 已配對刊登禁止編輯
  - 獲取申請人數量
  - 深色模式支援

- `src/app/api/listings/[id]/route.ts` - 新增：
  - 已配對刊登禁止編輯檢查
  - 編輯時移除所有申請人
  - 為被移除的申請人創建通知

**翻譯更新** (`messages/*.json`)：
- 新增 `theme` 區塊（主題相關翻譯）
- 更新 `profile` 區塊（新增我的申請、撤回相關）
- 更新 `edit` 區塊（新增警告、配對鎖定相關）
- 更新 `profileSettings` 區塊（OAuth 連結相關）
- 四語言完整翻譯（繁中/簡中/英文/日文）

### 待執行的 SQL：

需在 Supabase SQL Editor 執行 `supabase/add-notifications-table.sql` 來創建通知資料表。

### LINE/Discord OAuth 實作記錄（2025-12-19）：

**新增 API 路由：**
- `src/app/api/auth/link/line/route.ts` - LINE OAuth 發起連結
- `src/app/api/auth/link/line/callback/route.ts` - LINE OAuth 回調處理
- `src/app/api/auth/link/discord/route.ts` - Discord OAuth 發起連結
- `src/app/api/auth/link/discord/callback/route.ts` - Discord OAuth 回調處理
- `src/app/api/auth/unlink/route.ts` - 取消連結帳號

**實作流程：**
1. 用戶點擊「連結」按鈕
2. 重導向至 LINE/Discord OAuth 授權頁面
3. 用戶授權後回調至 `/api/auth/link/[provider]/callback`
4. 後端交換 code 取得 access token
5. 獲取用戶資料並儲存至資料庫
6. 重導向回設定頁面顯示成功訊息

**設定頁面更新** (`src/app/profile/settings/page.tsx`)：
- 移除手動輸入欄位
- 新增「連結」按鈕（綠色 LINE / 紫色 Discord）
- 已連結狀態顯示用戶名稱和「取消連結」按鈕
- 只有連結後才顯示「顯示在主辦頁面」開關
- 支援深色模式

**翻譯更新**：
- 新增 `connect`、`disconnect` 翻譯
- 新增連結成功/失敗訊息翻譯
- 四語言完整翻譯

**環境變數（已設定）：**
- `AUTH_LINE_ID` - LINE Channel ID
- `AUTH_LINE_SECRET` - LINE Channel Secret
- `AUTH_DISCORD_ID` - Discord Client ID
- `AUTH_DISCORD_SECRET` - Discord Client Secret

**重要：** 需在 LINE Developers Console 和 Discord Developer Portal 設定回調 URL：
- LINE: `https://ticketticket.live/api/auth/link/line/callback`
- Discord: `https://ticketticket.live/api/auth/link/discord/callback`

編譯測試通過

---

## 新需求 V11（2025-12-19 追加）

### 完整需求記錄：

1. 有關他人發布的活動卡片，可以看到名額，如果是2人票的話，就會顯示2/2這並沒有意義，請移除該資訊，連同查看頁面跟創建頁面時都不需要這個名額資訊一人票跟二人票已經很明顯地知道了
2. 有關他人發布的活動卡片，價格的部分會有"/人" 這個根本不需要，請移除所有地方的這個/人
3. 活動卡片上有活動地點，這個也不需要，請移除
4. 尋找同行者，必須選擇二人票，價格為票價的一半，這個訊息不需要給申請人看，這個只需要在創建活動的時候給活動主辦方看就好，另外價格為票價的一半這句話要移除，因為價格是可以更低且自己設定的的
5. 交易安全提醒的部分增加"請勿與陌生人進行線上轉帳或金錢交易避免遭受蒙騙！"
6. 活動卡片點進去的刊登詳情缺少活動主辦人的資訊，需要頭像、名稱、評價、已連結帳號的ICON(GOOGLE、LINE、DISCORD)當然不能點，要活動主辦方跟申請方已經相互通過申請後才能按
7. 接著這個活動卡片需要以下資訊：發布者頭像、發布者名稱、發布者評價、活動名稱、同行時間、活動價格
8. 目前所有用戶的頭像都會先顯示GOOGLE頭像，之後才會顯示自己設定的頭像，這樣會導致隱私爆露，請改成只會顯示改過的頭像一但有改過頭像，就不會再顯示GOOGLE的頭像
9. 申請已送出！的文字在深色主題時還是黑字，請改成白字
10. 當我到別人的活動卡片按下申請，卻發生我可以決定我要不要再消息的頁面接受我自己的申請，按下去沒有變化但不應該這樣
11. 我的申請應該要能夠在消息介面中也能撤回，不是只能在我的個人頁面撤回
12. 補上 tokushoho.subtitle 翻譯（zh-TW 缺少）

### 執行計劃：
- [x] 移除名額資訊（卡片、詳情、創建頁）✅ 2025-12-19
- [x] 移除價格的/人顯示 ✅ 2025-12-19
- [x] 移除活動卡片的地點資訊 ✅ 2025-12-19
- [x] 尋找同行者提示只給主辦方看，移除價格一半說明 ✅ 2025-12-19
- [x] 交易安全提醒增加警語 ✅ 2025-12-19
- [x] 刊登詳情增加主辦人資訊區塊 ✅ 2025-12-19
- [x] 活動卡片增加發布者資訊 ✅ 2025-12-19
- [x] 頭像隱私：只顯示自訂頭像 ✅ 2025-12-19
- [x] 申請已送出深色模式文字顏色 ✅ 2025-12-19
- [x] 修正自己申請自己的BUG ✅ 2025-12-19
- [x] 消息頁面增加撤回申請功能 ✅ 2025-12-19
- [x] 補上 tokushoho.subtitle 翻譯 ✅ 2025-12-19

### V11 實作記錄（2025-12-19）：

**ListingCard 元件更新** (`src/components/features/ListingCard.tsx`)：
- 移除名額資訊（slots）
- 移除地點資訊
- 移除價格的「/人」顯示
- 新增發布者資訊區塊（頭像、名稱、評價）移至卡片頂部
- 頭像改為優先顯示自訂頭像 `customAvatarUrl || avatarUrl`

**刊登詳情頁更新** (`src/app/listing/[id]/page.tsx`)：
- 移除申請彈窗中的「/人」顯示
- 修正成功彈窗深色模式文字顏色

**SafetyBanner 元件更新** (`src/components/ui/SafetyBanner.tsx`)：
- 新增詐騙警語 `scamWarning`
- 添加深色模式支援

**申請 API 修正** (`src/app/api/applications/route.ts`)：
- 修正收到申請的查詢邏輯
- 使用 `listingIds` 正確過濾
- 添加 `.neq('guest_id', userId)` 排除自己申請自己的情況

**消息頁面更新** (`src/app/messages/page.tsx`)：
- 新增申請撤回功能
- 新增撤回確認 Modal
- pending 狀態的申請顯示撤回按鈕
- 已撤回狀態顯示

**翻譯更新** (`messages/*.json`)：
- 新增 `safety.scamWarning` 四語言翻譯
- 新增 `messages.withdraw`、`cancelled`、`withdrawConfirmTitle` 等翻譯
- 新增 `tokushoho.subtitle` 四語言翻譯

編譯測試通過

---

## 優化：聊天頁面交易資訊區塊（2025-12-19）

### 需求記錄：
在消息介面中，與對方的談話上方，會顯示要面交的內容：
- 活動名稱
- 集合地點
- 集合時間
- 票種類型
- 刊登類型
- 希望費用

### 實作記錄：

**API 更新** (`src/app/api/conversations/[id]/route.ts`)：
- listing 查詢新增 `ticket_type`、`ticket_count_type`、`meeting_time`、`meeting_location` 欄位

**聊天頁面更新** (`src/app/chat/[id]/page.tsx`)：
- 新增完整的交易資訊區塊（漸層紫色背景）
- 顯示活動名稱（標題）
- 顯示集合時間、集合地點（2x2 網格）
- 顯示票種類型標籤（一人票/二人票/家庭票）
- 顯示刊登類型標籤（尋找同行/母票轉讓/子票轉讓/換票）
- 顯示希望費用（底部醒目顯示）

**翻譯更新** (`messages/*.json`)：
- 新增 `chat.expectedPrice` 翻譯
- 新增 `chat.ticketCount` 區塊（solo/duo/family）
- 新增 `chat.listingType` 區塊（find_companion/main_ticket_transfer/sub_ticket_transfer/ticket_exchange）
- 四語言完整翻譯（繁中/簡中/英文/日文）

編譯測試通過

---

## 新需求 V12（2025-12-20 追加）

### 完整需求記錄：

**票券驗證與評價系統優化**

1. **票券驗證流程**：
   - 主辦方同意申請人的申請之後進入可交流的過程（訊息）
   - 需要再經過一段申請人真正有收到票的驗證流程
   - 主辦方確認「已給票」+ 申請人確認「已收票」
   - 雙方都確認後才算完成

2. **評價解鎖條件**：
   - 雙方都確認票券驗證後才能互相評價
   - 與活動日期限制並存（相容舊資料）

3. **評價展示優化**：
   - 用戶個人頁面顯示所有收到的評價
   - 新增獨立評價頁面 `/reviews/[userId]`
   - 所有申請人都可以看到對方所有評價的留言

### 執行計劃：
- [x] Step 1: 資料庫變更（conversations 表新增確認欄位）✅ 2025-12-20
- [x] Step 2: 修改對話 API（回傳確認狀態）✅ 2025-12-20
- [x] Step 3: 新增確認 API ✅ 2025-12-20
- [x] Step 4: 修改評價權限 API ✅ 2025-12-20
- [x] Step 5: 修改評價提交 API ✅ 2025-12-20
- [x] Step 6: 新增用戶評價列表 API ✅ 2025-12-20
- [x] Step 7: 聊天頁面新增驗證區塊 ✅ 2025-12-20
- [x] Step 8: 新增評價頁面 ✅ 2025-12-20
- [x] Step 9: 修改個人頁面 ✅ 2025-12-20
- [x] Step 10: 翻譯檔案 ✅ 2025-12-20
- [x] Step 11: 類型定義 ✅ 2025-12-20

### V12 實作記錄（2025-12-20）：

**資料庫變更** (`supabase/add-ticket-verification.sql`)：
- 新增 `host_confirmed_at` 欄位（主辦方確認時間）
- 新增 `guest_confirmed_at` 欄位（申請人確認時間）
- 新增索引優化查詢

**API 更新**：
- `src/app/api/conversations/[id]/route.ts` - GET 回傳確認狀態
- `src/app/api/conversations/[id]/confirm/route.ts` - 新增確認 API（POST）
- `src/app/api/reviews/can-review/[listingId]/route.ts` - 評價權限新增雙方確認檢查
- `src/app/api/reviews/route.ts` - 評價提交新增驗證邏輯
- `src/app/api/users/[userId]/reviews/route.ts` - 新增用戶評價列表 API（分頁）

**頁面更新**：
- `src/app/chat/[id]/page.tsx` - 新增票券驗證區塊
  - 顯示主辦方/申請人確認狀態
  - 確認/取消按鈕
  - 雙方確認後顯示評價按鈕
- `src/app/reviews/[userId]/page.tsx` - 新增用戶評價頁面
  - 用戶資訊卡片
  - 評分分布圖
  - 評價列表（分頁）
- `src/app/profile/page.tsx` - 評價區塊新增「查看全部」連結

**翻譯更新** (`messages/*.json`)：
- 新增 `verification` 區塊（票券驗證相關）
- 新增 `reviews` 區塊（評價頁面相關）
- 新增 `review.viewAll` 翻譯
- 四語言完整翻譯（繁中/簡中/英文/日文）

### 待執行的 SQL：

需在 Supabase SQL Editor 執行 `supabase/add-ticket-verification.sql` 來新增確認欄位。

```sql
ALTER TABLE conversations ADD COLUMN IF NOT EXISTS host_confirmed_at TIMESTAMP WITH TIME ZONE DEFAULT NULL;
ALTER TABLE conversations ADD COLUMN IF NOT EXISTS guest_confirmed_at TIMESTAMP WITH TIME ZONE DEFAULT NULL;
```

編譯測試通過

---

## 新需求 V13（2025-12-20 追加）

### 完整需求記錄：

**管理員後台系統**

1. **活動管理頁面** (`/admin/listings`)
   - 列表形式顯示所有活動（非卡片形式，類似後台管理）
   - 支援搜尋、篩選（狀態、日期）、排序
   - 可強制編輯刊登內容
   - 可強制移除刊登
   - 移除/編輯時可選擇是否通知相關用戶（主辦方、所有申請者）
   - 通知透過系統訊息發送

2. **會員管理頁面** (`/admin/users`)
   - 列表形式顯示所有會員
   - 支援搜尋（暱稱、Email）
   - 可強制更改暱稱
   - 可強制更改/移除頭像
   - 可加入/移出黑名單
   - 查看用戶刊登歷史和評價

3. **黑名單系統**
   - 新增 `blacklist` 資料表
   - 封鎖條件：Google 帳號 Email
   - 被封鎖用戶無法登入和註冊
   - 封鎖時可填寫原因
   - 支援解除封鎖

### OpenSpec 提案：
- `openspec/changes/admin-management-system/proposal.md`
- `openspec/changes/admin-management-system/tasks.md`
- `openspec/changes/admin-management-system/specs/data-models.md`
- `openspec/changes/admin-management-system/specs/api-contracts.md`
- `openspec/changes/admin-management-system/specs/ui-specifications.md`
- `openspec/changes/admin-management-system/specs/scenarios.md`

### 執行計劃：
- [x] Step 1.1: 建立黑名單資料表 ✅ 2025-12-20
- [x] Step 1.2: 建立管理員操作日誌表 ✅ 2025-12-20
- [x] Step 1.3: 修改登入流程檢查黑名單 ✅ 2025-12-20
- [x] Step 2.1: 刊登管理 API ✅ 2025-12-20
- [x] Step 2.2: 管理員通知 API ✅ 2025-12-20
- [x] Step 2.3: 刊登管理頁面 ✅ 2025-12-20
- [x] Step 3.1: 會員管理 API ✅ 2025-12-20
- [x] Step 3.2: 會員管理頁面 ✅ 2025-12-20
- [x] Step 3.3: 黑名單管理頁面 ✅ 2025-12-20
- [x] Step 4.1: 更新管理員側邊欄 ✅ 2025-12-20

### V13 實作記錄（2025-12-20）：

**資料庫變更** (`supabase/add-admin-management-tables.sql`)：
- 新增 `blacklist` 資料表（封鎖 Email、原因、時間）
- 新增 `admin_logs` 資料表（操作日誌）
- 新增 `messages` 表系統訊息欄位
- 新增 RLS 政策

**登入流程修改** (`src/auth.ts`)：
- signIn callback 新增黑名單檢查
- 被封鎖用戶重導向至 `/login?error=AccountBlocked`

**登入頁面更新** (`src/app/login/page.tsx`)：
- 新增 `AccountBlocked` 錯誤訊息處理

**API 新增**：
- `GET /api/admin/listings` - 刊登列表（分頁、搜尋、篩選）
- `PUT /api/admin/listings/[id]` - 強制編輯刊登
- `DELETE /api/admin/listings/[id]` - 強制移除刊登
- `GET /api/admin/users` - 會員列表
- `PUT /api/admin/users/[id]` - 更新會員資料
- `POST /api/admin/users/[id]/blacklist` - 加入黑名單
- `DELETE /api/admin/users/[id]/blacklist` - 移出黑名單
- `GET /api/admin/blacklist` - 黑名單列表
- `DELETE /api/admin/blacklist/[id]` - 刪除黑名單記錄

**頁面新增**：
- `/admin/listings` - 刊登管理頁面（表格列表、搜尋篩選、編輯/刪除 Modal）
- `/admin/users` - 會員管理頁面（表格列表、編輯/封鎖 Modal）
- `/admin/blacklist` - 黑名單管理頁面

**管理員側邊欄更新** (`src/app/admin/layout.tsx`)：
- 新增「刊登管理」連結
- 新增「會員管理」連結
- 新增「黑名單」連結

**翻譯更新** (`messages/*.json`)：
- 新增 `auth.accountBlocked` 翻譯（四語言）

### 待執行的 SQL：

需在 Supabase SQL Editor 執行 `supabase/add-admin-management-tables.sql` 來建立管理員相關資料表。

編譯測試通過

---

## 新需求 V14（2025-12-20 追加）

### 完整需求記錄：

**用戶權限系統大調整 - 分成四種角色：**

1. **訪客 (guest)**
   - 可以看首頁、可以自由觀看主頁、可以使用探索功能（首頁搜尋篩選）、可以點進活動卡片
   - 但是點申請或是其他任何功能全部都會要求登入

2. **一般用戶 (user)**
   - 跟現在的正常帳號一樣，刊登上限也是2則

3. **副管理員 (sub_admin)**
   - 需要由主管理員在會員管理頁面指定
   - 輸入密碼 `pekomura01120717` 可以進入 ADMIN 頁面
   - 無法針對主管理員進行任何編輯
   - 不能給任何人管理員權限

4. **主管理員 (super_admin)**
   - 只會有一個人，也就是 `lmmlmm16861@gmail.com`
   - 同樣要輸入 `pekomura01120717` 才能進入後台
   - 擁有所有權限，也能給任何人副管理員權限
   - 點擊編輯就能夠看到兩個按鈕：[給予副管理權限] [轉讓站主]
   - 給予副管理權限會跳出一個警告提示確認
   - 轉讓站主會先跳警告，然後輸入特殊密碼 `Destiny219870818` 才能將主管理員的權限轉給該成員
   - 自己將會變成副管理權限

### 執行計劃：
- [x] 階段1：建立資料庫 migration (add-user-role.sql) ✅ 2025-12-20
- [x] 階段2：更新類型定義 (types/index.ts, next-auth.d.ts, supabase.ts) ✅ 2025-12-21
- [x] 階段3：建立權限驗證工具 (auth-helpers.ts) ✅ 2025-12-21
- [x] 階段4：更新 NextAuth 配置 (auth.ts) ✅ 2025-12-21
- [x] 階段5：建立新 API (verify, role) ✅ 2025-12-21
- [x] 階段6：保護現有 Admin API (7個檔案) ✅ 2025-12-21
- [x] 階段7：重構 AdminContext ✅ 2025-12-21
- [x] 階段8：更新管理員 UI (layout, users page) ✅ 2025-12-21

### V14 實作記錄（2025-12-20 ~ 2025-12-21）：

**資料庫變更** (`supabase/add-user-role.sql`)：
- 新增 `role` 欄位（預設為 'user'）
- 建立索引 `idx_users_role`
- 初始化主管理員 `lmmlmm16861@gmail.com` 為 `super_admin`

**新增檔案：**
- `supabase/add-user-role.sql` - 資料庫 migration
- `src/lib/auth-helpers.ts` - 權限驗證工具 ✅
- `src/app/api/admin/verify/route.ts` - 管理員驗證 API ✅
- `src/app/api/admin/users/[id]/role/route.ts` - 角色管理 API ✅

**修改檔案：**
- `src/types/index.ts` - 新增 UserRole 類型和 ROLE_HIERARCHY ✅
- `src/types/next-auth.d.ts` - Session/JWT 擴展 role 欄位 ✅
- `src/lib/supabase.ts` - DbUser 類型新增 role ✅
- `src/auth.ts` - callbacks 處理 role（signIn/jwt/session）✅
- `src/contexts/AdminContext.tsx` - 重構認證邏輯（async login, role state）✅
- `src/app/admin/layout.tsx` - 登入流程（loading 狀態、角色徽章）✅
- `src/app/admin/users/page.tsx` - 角色管理 UI（角色欄位、授權按鈕、Modal）✅
- `src/app/api/admin/users/route.ts` - 權限檢查 + role 欄位 ✅
- `src/app/api/admin/users/[id]/route.ts` - 權限檢查 ✅
- `src/app/api/admin/users/[id]/blacklist/route.ts` - 權限檢查 ✅
- `src/app/api/admin/listings/route.ts` - 權限檢查 ✅
- `src/app/api/admin/listings/[id]/route.ts` - 權限檢查 ✅
- `src/app/api/admin/blacklist/route.ts` - 權限檢查 ✅
- `src/app/api/admin/blacklist/[id]/route.ts` - 權限檢查 ✅

### 角色權限邏輯：

| 角色 | 進入後台 | 管理刊登/會員 | 授權副管理 | 轉讓站主 |
|-----|---------|-------------|----------|---------|
| user | ✗ | ✗ | ✗ | ✗ |
| sub_admin | ✓（需密碼） | ✓（不可編輯主管理員）| ✗ | ✗ |
| super_admin | ✓（需密碼） | ✓ | ✓ | ✓（需特殊密碼）|

### 待執行的 SQL：

需在 Supabase SQL Editor 執行 `supabase/add-user-role.sql` 來新增用戶角色欄位。

編譯測試：✅ 通過 (2025-12-21)

---

## 新需求 V15（2025-12-21 追加）

### 完整需求記錄：

**檢舉系統功能**

1. **用戶檢舉功能**
   - 申請者可在「聊天」、「刊登詳情」檢舉對方
   - 主辦方可在「聊天」檢舉對方
   - 檢舉類型：疑似黃牛、票券相關、疑似惡意詐欺、金額交易相關
   - 檢舉時需填寫詳細說明

2. **管理員檢舉管理頁面** (`/admin/reports`)
   - 列表形式顯示所有檢舉
   - 篩選狀態：待處理、處理中、已解決、已駁回
   - 查看檢舉詳情、對話記錄、活動資訊
   - 顯示被檢舉用戶 Email（供手動發送警告）
   - 可封鎖用戶、更新狀態、填寫備註

### 執行計劃：
- [x] 階段1：資料庫 migration (add-reports-table.sql) ✅ 2025-12-21
- [x] 階段2：類型定義 (ReportType, ReportStatus, Report interface) ✅ 2025-12-21
- [x] 階段3：ReportModal 元件 ✅ 2025-12-21
- [x] 階段4：用戶檢舉 API (/api/reports) ✅ 2025-12-21
- [x] 階段5：頁面加入檢舉按鈕（chat, listing detail）✅ 2025-12-21
- [x] 階段6：管理員 API (/api/admin/reports) ✅ 2025-12-21
- [x] 階段7：管理員檢舉頁面 (/admin/reports) ✅ 2025-12-21
- [x] 階段8：Admin 導航更新 ✅ 2025-12-21
- [x] 階段9：翻譯（四語言）✅ 2025-12-21

### V15 實作記錄（2025-12-21）：

**資料庫變更** (`supabase/add-reports-table.sql`)：
- 新增 `reports` 資料表
- 欄位：reporter_id, reported_user_id, conversation_id, listing_id, report_type, reason, status, admin_notes, resolved_by, created_at, resolved_at
- 新增索引（status, reporter, reported）

**類型定義更新** (`src/types/index.ts`)：
- 新增 `ReportType`：scalper, ticket_issue, fraud, payment_issue
- 新增 `ReportStatus`：pending, investigating, resolved, dismissed
- 新增 `Report` 介面
- 新增 `REPORT_TYPE_INFO` 常數（標籤和顏色）

**新增檔案**：
- `supabase/add-reports-table.sql` - 資料庫 migration
- `src/components/ui/ReportModal.tsx` - 檢舉彈窗元件
- `src/app/api/reports/route.ts` - 用戶檢舉 API (GET/POST)
- `src/app/api/admin/reports/route.ts` - 管理員列表 API
- `src/app/api/admin/reports/[id]/route.ts` - 管理員詳情 API (GET/PUT/DELETE)
- `src/app/admin/reports/page.tsx` - 管理員檢舉頁面

**修改檔案**：
- `src/app/chat/[id]/page.tsx` - 新增檢舉按鈕（Header rightAction）
- `src/app/listing/[id]/page.tsx` - 新增檢舉按鈕（主辦方資訊區塊）
- `src/app/admin/layout.tsx` - 新增「檢舉管理」導航連結

**翻譯更新** (`messages/*.json`)：
- 新增 `report` 區塊（用戶檢舉相關）
- 新增 `adminReports` 區塊（管理員檢舉管理）
- 四語言完整翻譯（繁中/簡中/英文/日文）

### 待執行的 SQL：

需在 Supabase SQL Editor 執行 `supabase/add-reports-table.sql` 來建立檢舉資料表。

編譯測試：✅ 通過 (2025-12-21)

---

## 新需求 V16（2025-12-24 追加）

### Discord Webhook 通知系統

**需求描述：**
建立 Discord Webhook 通知系統，讓管理員和用戶可以透過 Discord 接收新刊登通知。

**技術選型：**
- **Inngest**：非同步任務處理，免費額度 50,000 事件/月
- **Discord Webhook**：免費，由 Discord 負責訊息傳遞
- **Vercel**：API 路由處理，Inngest 整合

### 執行計劃：
- [x] 安裝 Inngest 套件並設定 ✅ 2025-12-24
- [x] 建立 Discord Webhook 資料表 SQL ✅ 2025-12-24
- [x] 新增 Webhook 類型定義 ✅ 2025-12-24
- [x] 建立 Inngest client 和函數 ✅ 2025-12-24
- [x] 建立 Discord 發送工具函數 ✅ 2025-12-24
- [x] 建立用戶 Webhook 管理 API ✅ 2025-12-24
- [x] 更新刊登 API 觸發通知 ✅ 2025-12-24
- [x] 管理員活動編輯 - 新增 Webhook 欄位 ✅ 2025-12-24
- [x] 用戶設定頁面 - 新增 Webhook 設定 ✅ 2025-12-24
- [x] 新增翻譯（四語言）✅ 2025-12-24

### V16 實作記錄（2025-12-24）：

**安裝套件**：
- `inngest` - 非同步任務處理

**新增檔案**：
- `src/lib/inngest.ts` - Inngest client 配置
- `src/lib/inngest-functions.ts` - Webhook 發送函數
- `src/app/api/inngest/route.ts` - Inngest serve 路由
- `src/app/api/webhooks/route.ts` - 用戶 Webhook CRUD API
- `src/app/api/webhooks/subscriptions/route.ts` - 活動訂閱 API
- `src/app/api/webhooks/test/route.ts` - Webhook 測試 API
- `supabase/add-discord-webhooks.sql` - 資料庫 migration

**修改檔案**：
- `src/types/index.ts` - 新增 Webhook 相關類型
- `src/app/api/listings/route.ts` - 發布刊登時觸發 Inngest 通知
- `src/app/api/events/route.ts` - POST 新增 discord_webhook_url 欄位
- `src/app/api/events/[id]/route.ts` - PATCH 新增 discord_webhook_url 欄位
- `src/components/admin/EventForm.tsx` - 新增 Discord Webhook URL 輸入欄位
- `src/app/profile/settings/page.tsx` - 新增用戶 Webhook 設定區塊

**翻譯更新** (`messages/*.json`)：
- 新增 `profileSettings.webhook` 區塊
- 四語言完整翻譯（繁中/簡中/英文/日文）

### 資料庫變更

需在 Supabase SQL Editor 執行 `supabase/add-discord-webhooks.sql`：

```sql
-- 1. events 表新增 discord_webhook_url 欄位
ALTER TABLE events ADD COLUMN IF NOT EXISTS discord_webhook_url TEXT;

-- 2. 用戶 Webhook 訂閱表
CREATE TABLE IF NOT EXISTS user_webhook_subscriptions (...)

-- 3. 用戶 Discord Webhook 設定表
CREATE TABLE IF NOT EXISTS user_discord_webhooks (...)

-- 4. Webhook 發送日誌表
CREATE TABLE IF NOT EXISTS webhook_logs (...)
```

### Inngest 設定

需在 Inngest Dashboard 完成以下設定：
1. 登入 https://app.inngest.com
2. 連結 Vercel 專案
3. 環境變數會自動設定（INNGEST_SIGNING_KEY, INNGEST_EVENT_KEY）

### 功能說明

**管理員功能**：
- 在活動編輯頁面設定 Discord Webhook URL
- 當該活動有新刊登時自動通知

**用戶功能**：
- 在個人設定頁面設定 Discord Webhook
- 訂閱特定活動的通知
- 測試 Webhook 連線
- 刪除 Webhook 設定

**通知內容**：
- 活動名稱
- 刊登描述
- 主辦人名稱
- 活動日期
- 票種資訊
- 刊登連結按鈕

編譯測試：✅ 通過 (2025-12-24)

---
