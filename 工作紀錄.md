# Zaiko Ticket Companion Matching Platform (MVP) 工作紀錄

## 需求文件（完整記錄）

### Project: Zaiko Ticket Companion Matching Platform (MVP)

### Role
Act as a Senior Full-Stack Developer. Build a mobile-first web application deployed on Vercel.

### Goal
Create a "Concert Companion Matching" platform for users holding Zaiko electronic tickets.
The core concept is NOT reselling tickets/accounts, but finding a partner to enter the venue together ("Shared Entry").
NO online payment processing. 全部 payments are settled offline (Face-to-Face).

### Tech Stack
- Framework: Next.js (App Router)
- Styling: Tailwind CSS
- Deployment: Vercel
- Icons: Lucide React
- Database/Auth (Mock for MVP): Use local state or mock data structures first. (Plan for Supabase later).

### Core Features & Requirements

1. **Ticket Listing 系統 (The Host)**
   - Create a post with fields: Event Name, Date, Venue, Meeting Time.
   - **Price Validator**: Input JPY (Original Price). 系統 must auto-convert to TWD (simulate fixed rate 0.22 for now).
   - **Constraint**: The asking price CANNOT exceed the (Original Price / Number of people). It must be a "cost-sharing" model.
   - **Ticket Type Tags**:
     - "Must Enter Together" (Host holds main ticket)
     - "Inbound/Overseas Ticket" (ID check warning)
     - "Separate Link"
   - **狀態**: Open / Matched / Closed.

2. **搜尋 & Discovery (The Guest)**
   - List view of available companion slots.
   - Filter by Date or Keyword.
   - Button: "Apply to Join" (NOT "Buy Now").

3. **Matching & Communication Flow**
   - User A (Guest) applies -> User B (Host) accepts.
   - Once matched, unlock a **Private Chat Interface**.
   - **Safety Warning**: Display a persistent banner in chat: "Host must be present for entry. Do not transfer money online. Meet at the venue."

4. **Review 系統**
   - Simple 5-star rating and comment system after the event date.

5. **Legal & Disclaimer (Critical)**
   - A modal on first visit: "This platform is for companion matching, not ticket resale. We are not responsible for entry refusal due to ID checks."

### UI/UX Design
- **Mobile-First**: Users will use this at the concert venue.
- **Trustworthy**: Clean, modern interface.
- **Visuals**: Use clear badges for "Price" and "Ticket Type".

### Output
Generate the project structure and key components for this application. Focus on the frontend flow and the logic for the "Price Validator" and "Matching Status".

語言：繁體中文

---

## 執行進度

### 階段 1：專案初始化 ✅
- [x] 建立 Next.js 專案結構
- [x] 設定 Tailwind CSS
- [x] 安裝 Lucide React
- [x] 安裝 OpenSpec (Spec-driven development)

### 階段 2：核心元件開發 ✅
- [x] 建立共用元件（Header, BottomNav, Card, Modal）
- [x] 建立票券刊登表單
- [x] 建立價格驗證器
- [x] 建立票券類型標籤
- [x] 建立 Button, Input, Avatar, StarRating 等 UI 元件
- [x] 建立 SafetyBanner 安全警告元件

### 階段 3：頁面開發 ✅
- [x] 首頁（票券列表）
- [x] 探索頁（搜尋篩選）
- [x] 票券詳情頁
- [x] 發布票券頁
- [x] 訊息管理頁（配對申請管理）
- [x] 聊天介面
- [x] 個人頁

### 階段 4：功能整合 ✅
- [x] 搜尋與篩選功能
- [x] 配對流程（申請/接受/拒絕）
- [x] 免責聲明 Modal（首次訪問檢測）
- [x] 聊天安全警告橫幅
- [x] 模擬資料整合

---

## 專案結構

```
TicketTicket/
├── openspec/                    # OpenSpec 規格文件
│   ├── specs/                   # 功能規格
│   │   ├── project/            # 專案概述
│   │   ├── data-models/        # 資料模型
│   │   ├── features/           # 功能規格
│   │   │   ├── listing-system/
│   │   │   ├── search-system/
│   │   │   ├── matching-system/
│   │   │   ├── review-system/
│   │   │   └── legal-disclaimer/
│   │   └── ui/                 # UI 規格
│   └── changes/                # 變更提案
│       └── mvp-implementation/
├── src/
│   ├── app/                    # Next.js App Router 頁面
│   │   ├── page.tsx            # 首頁
│   │   ├── explore/            # 探索頁
│   │   ├── listing/[id]/       # 刊登詳情頁
│   │   ├── create/             # 發布頁
│   │   ├── messages/           # 訊息管理頁
│   │   ├── chat/[id]/          # 聊天頁
│   │   └── profile/            # 個人頁
│   ├── components/
│   │   ├── ui/                 # 基礎 UI 元件
│   │   ├── layout/             # 佈局元件
│   │   └── features/           # 功能元件
│   ├── contexts/               # React Context
│   ├── data/                   # 模擬資料
│   └── types/                  # TypeScript 型別
└── package.json
```

---

## 更新日誌

### 2025-12-14
- 使用 OpenSpec 進行 Spec-driven development
- 建立完整的功能規格文件
- 完成 MVP 核心功能開發
- 專案編譯測試通過

---

## 啟動指令

```bash
# 開發模式
npm run dev

# 編譯
npm run build

# 啟動生產版本
npm start
```

---

## 新需求 V2（2025-12-14 追加）

### 完整需求記錄：
1. 你是如何抓票資料的，還是那是假的 → **目前是假資料(模擬)，需接 Supabase**
2. 你怎麼去儲存跟抓取資料的 → **目前用 React Context + localStorage，需改 Supabase**
3. 你怎麼做到線上訊息的 → **目前模擬，需 WebSocket/Supabase Realtime**
4. 請上設計成電腦跟手機版本能有不同顯示的模式 → **響應式設計優化**
5. 名稱的部分我想設計成選擇的 → **活動名稱改為下拉選單**
6. 能不能使用LINE登入認證? → **整合 LINE Login API**
7. 請移除所有什麼分攤帳款的公告跟訊息 → **移除分攤相關文字**
8. 整體設計必須合日本法律 → **日本法律合規調整**
9. APP剛登入時必須強制選擇語言 [繁體中文] [簡體中文] [日本語] [ENGLISH] → **強制語言選擇**
10. 所有介面會跟著切換 → **多語言系統 (i18n)**

### 執行計劃：
- [x] 建立多語言系統 (next-intl) ✅ 2025-12-14
- [x] 強制語言選擇 Modal（首次訪問）✅ 2025-12-14
- [x] 移除所有分攤帳款相關訊息 ✅ 2025-12-14
- [x] 響應式設計優化（電腦/手機不同佈局）✅ 2025-12-15
- [x] 活動名稱改為選擇式 ✅ 2025-12-15
- [x] 日本法律合規調整（特定商取引法等）✅ 2025-12-15
- [ ] LINE 登入準備（next-auth + LINE Provider）
- [ ] Supabase 資料庫整合
- [ ] 即時訊息功能

### V2 多語言實作記錄（2025-12-14）：
- 安裝 `next-intl` 套件
- 建立語言檔案：`messages/zh-TW.json`, `messages/zh-CN.json`, `messages/ja.json`, `messages/en.json`
- 建立語言配置：`src/i18n/config.ts`, `src/i18n/request.ts`
- 建立語言 Context：`src/contexts/LanguageContext.tsx`
- 建立語言選擇 Modal：`src/components/layout/LanguageModal.tsx`
- 更新 `next.config.ts` 支援 next-intl
- 更新 `layout.tsx` 加入 NextIntlClientProvider
- 更新所有頁面和元件使用 `useTranslations` hook
- 語言儲存於 localStorage 和 cookie，cookie 供 server 端使用
- 首次訪問強制選擇語言，之後顯示免責聲明
- 移除所有「分攤帳款」相關文字，改為「費用」或「價格」
- 編譯測試通過

### V2 響應式設計實作記錄（2025-12-15）：
- 建立桌面版側邊導覽：`src/components/layout/SideNav.tsx`
- 更新底部導覽：手機版顯示，桌面版隱藏 (`lg:hidden`)
- 更新 `layout.tsx`：加入 SideNav，flex 佈局，main 區塊 `lg:ml-64`
- 更新 `Header.tsx`：桌面版偏移 `lg:left-64`
- 更新首頁：桌面版 grid 2-3 欄佈局
- 更新探索頁：桌面版 grid 佈局
- 更新訊息頁：桌面版 grid 佈局
- 更新個人頁：桌面版 grid 佈局
- 更新發布頁：底部按鈕偏移 `lg:left-64 lg:bottom-0`
- 更新詳情頁：底部按鈕偏移 `lg:left-64 lg:bottom-0`
- 編譯測試通過

### V2 活動名稱選擇式實作記錄（2025-12-15）：
- 建立活動資料檔：`src/data/events.ts`
- 包含 40+ 熱門日本音樂活動（J-POP、偶像團體、VTuber、音樂祭）
- 建立可搜尋選擇元件：`src/components/ui/Select.tsx`
- 支援搜尋篩選、自訂輸入選項
- 更新發布頁使用下拉選單選擇活動
- 加入多語言翻譯「其他活動（自行輸入）」
- 編譯測試通過

### V2 日本法律合規調整實作記錄（2025-12-15）：
- 建立法律頁腳元件：`src/components/layout/LegalFooter.tsx`
- 建立特定商取引法公示頁：`src/app/legal/tokushoho/page.tsx`
- 加入四語言法律翻譯（legal, tokushoho）
- 包含：事業者名稱、負責人、服務內容、費用、支付方式、退費規定、重要聲明
- 更新 Profile 頁面加入法律連結（特定商取引法表示）
- 符合日本特定商取引法要求
- 編譯測試通過

### V2 應用內語言切換功能（2025-12-15）：
- 建立語言切換元件：`src/components/ui/LanguageSwitcher.tsx`
- 支援兩種顯示模式：button（按鈕）、menu-item（選單項）
- 國旗 + 語言名稱顯示
- 點擊彈出語言選擇 Modal
- Profile 頁面設定選單加入語言切換
- 桌面版 SideNav 底部加入語言切換按鈕
- 編譯測試通過

### V2 HOLOLIVE 活動管理系統（2025-12-15）：
- 建立活動型別定義：`src/types/index.ts` 新增 `HololiveEvent`、`EventCategory`
- 建立管理員 Context：`src/contexts/AdminContext.tsx`
  - 活動 CRUD 操作（新增、編輯、刪除）
  - 簡易密碼驗證（預設密碼：hololive2025）
  - localStorage 資料持久化
  - 預設 8 個 HOLOLIVE 活動
- 建立管理員佈局：`src/app/admin/layout.tsx`
  - 深色主題 Header
  - 密碼登入介面
  - 登出功能
- 建立活動管理頁面：
  - `/admin/events` - 活動列表（搜尋、篩選、顯示/隱藏切換）
  - `/admin/events/new` - 新增活動
  - `/admin/events/[id]` - 編輯活動
- 建立活動表單元件：`src/components/admin/EventForm.tsx`
  - 完整欄位：名稱、藝人、日期、場地、票價、連結等
  - 分類選擇（演唱會、粉絲見面會、展覽、線上直播、其他）
  - 表單驗證
- 更新 `src/data/events.ts` 改為 HOLOLIVE 專用清單
  - 包含 50+ HOLOLIVE 相關活動
  - JP / EN / ID / HOLOSTARS 全覆蓋
- 編譯測試通過

---

## 新需求 V3（2025-12-15 追加）

### 完整需求記錄：

**票務資訊調整：**
1. 座位等級：B > A > S > SS
2. 票種類型：一人、二人、家庭(Family)
3. 移除開賣時間和截止時間（同行系統不需要）

**功能補充：**
7. 必須寫上當天自己的穿著或者是顯眼可辨識的特徵
8. 日期、集合地點（已存在）
9. 非商用且不收任何手續費用聲明
10. 必須寫上持有票人的國籍、可使用語言
11. 主辦人額外需求（主辦人為女性，只想找同行者女性）
12. 加入，此頁面僅服務vtuber粉絲，無任何手續費，但不介意以後開放斗內
13. 加入一些基本的禁詞表

### V3 實作記錄（2025-12-15）：

**型別更新** (`src/types/index.ts`)：
- 新增 `SeatGrade`：B / A / S / SS
- 新增 `TicketCountType`：solo / duo / family
- 新增 `Gender`：male / female / other / any
- 擴充 `Listing` 介面：
  - `seatGrade` 座位等級
  - `ticketCountType` 票種類型
  - `hostNationality` 主辦人國籍
  - `hostLanguages` 可使用語言（陣列）
  - `identificationFeatures` 辨識特徵
  - `hostGender` 主辦人性別
  - `preferredGender` 希望同行者性別
- 新增常數：`SEAT_GRADE_INFO`、`TICKET_COUNT_TYPE_INFO`、`GENDER_INFO`
- 新增選項：`NATIONALITY_OPTIONS`（14個國籍）、`LANGUAGE_OPTIONS`（8種語言）

**發布表單更新** (`src/app/create/page.tsx`)：
- 座位等級選擇（B/A/S/SS 按鈕組）
- 票種類型選擇（一人/二人/家庭 按鈕組）
- 國籍下拉選單
- 語言多選按鈕組
- 主辦人性別選擇
- 希望同行者性別選擇
- 辨識特徵輸入（必填）

**免責聲明更新** (`src/components/layout/DisclaimerModal.tsx`)：
- 新增「VTuber 粉絲專屬平台」區塊（粉色背景）
- 新增「非商用・零手續費」區塊（綠色背景）
- 四語言翻譯更新

**禁詞過濾** (`src/utils/contentFilter.ts`)：
- 建立禁詞列表（約炮/詐騙/黃牛/不當言論）
- 支援中/英/日多語言
- 提供函數：`containsBannedWords`、`findBannedWords`、`censorBannedWords`、`validateContent`

**模擬資料更新** (`src/data/mock.ts`)：
- 改為 HOLOLIVE 主題
- 所有 Listing 加入新欄位

編譯測試通過

### V3 開賣時間/售票截止欄位移除（2025-12-15）：

已從以下檔案移除 `ticketSaleStart` 和 `ticketSaleEnd` 欄位：
- `src/types/index.ts` - HololiveEvent 介面
- `src/components/admin/EventForm.tsx` - 表單資料狀態與提交處理
- `src/contexts/AdminContext.tsx` - 預設活動資料與解析函數

編譯測試通過

---

## 待辦事項（MVP 後續）

- [x] HOLOLIVE 活動管理系統 ✅
- [x] 評價系統功能 ✅ 2025-12-17
- [x] 完整的用戶檔案頁 ✅ 2025-12-17
- [x] 頁尾法律連結 ✅ 2025-12-17
- [x] Vercel 部署 ✅
- [x] Supabase 資料庫整合 ✅
- [x] Google OAuth 登入整合 ✅

**所有 MVP 後續工作項目已完成！**

---

## 新需求 V4（2025-12-17 追加）

### 完整需求記錄：

**登入系統調整：**
1. 只開放 GOOGLE 登入（移除 LINE、Discord 登入按鈕）
2. 訪客如要申請、開活動、進入個人頁面，都會跳轉登入頁

**個人設定頁面功能：**
1. 名稱更改功能
2. 頭像上傳更改功能
3. 手機電話（含國碼選擇）- 選填，告知非必要但可讓對方在需要時聯絡
4. 連結帳號功能：
   - LINE ID 連結
   - Discord ID 連結
   - 這兩個會顯示在活動發起人的頁面（僅 ICON）
   - 只有申請活動後才能看見
   - 可在個人設定中決定是否顯示

### 執行計劃：
- [x] 登入頁面只保留 Google 登入 ✅ 2025-12-17
- [x] 個人設定：名稱更改功能 ✅ 2025-12-17
- [x] 個人設定：頭像上傳更改功能 ✅ 2025-12-17
- [x] 個人設定：手機電話（含國碼）選填 ✅ 2025-12-17
- [x] 個人設定：LINE/Discord 連結帳號與顯示控制 ✅ 2025-12-17
- [x] 更新資料庫 schema 加入新欄位 ✅ 2025-12-17
- [x] 建立個人資料更新 API ✅ 2025-12-17
- [x] 活動發起人頁面顯示 LINE/Discord icon（僅申請後可見）✅ 2025-12-17

### V4 實作記錄（2025-12-17）：

**登入頁面更新** (`src/app/login/page.tsx`)：
- 移除 LINE 和 Discord 登入按鈕
- 只保留 Google 登入，使用彩色 Google 圖示

**資料庫 Schema 更新** (`supabase/schema.sql`, `supabase/add-user-profile-fields.sql`)：
- 新增 `custom_avatar_url` 欄位（用戶上傳的自訂頭像）
- 新增 `phone_country_code` 和 `phone_number` 欄位
- 新增 `line_id` 和 `discord_id` 欄位
- 新增 `show_line` 和 `show_discord` 欄位（控制是否顯示在主辦頁面）
- 新增電話索引

**類型更新** (`src/types/index.ts`)：
- User 介面新增：customAvatarUrl, phoneCountryCode, phoneNumber, lineId, discordId, showLine, showDiscord
- 新增 PHONE_COUNTRY_CODES 常數（13 個常用國碼）

**API 路由**：
- `src/app/api/profile/route.ts` - GET/PATCH 用戶資料
- `src/app/api/profile/avatar/route.ts` - POST 上傳頭像 / DELETE 移除頭像

**個人設定頁面** (`src/app/profile/settings/page.tsx`)：
- 頭像上傳/更換功能（支援 Supabase Storage 或 data URL）
- 顯示名稱修改
- 手機電話（含國碼下拉選單）
- LINE ID / Discord ID 連結
- 顯示控制開關（是否在主辦頁面顯示）

**翻譯更新** (`messages/*.json`)：
- 新增 profileSettings 區塊，包含所有設定頁面文字
- 支援繁體中文、簡體中文、日文、英文

**刊登詳情頁更新** (`src/app/listing/[id]/page.tsx`)：
- 主辦方區塊新增 LINE/Discord 圖示顯示
- 僅在用戶已申請後才顯示（hasApplied = true）
- 顯示條件：host.showLine 或 host.showDiscord 為 true

**Context 更新** (`src/contexts/AppContext.tsx`)：
- ApiUser 介面新增新欄位
- convertApiListingToListing 函數新增欄位轉換

**Listings API 更新** (`src/app/api/listings/route.ts`)：
- 查詢時包含 host 的新欄位

編譯測試通過

---

## 新需求 V5（2025-12-17 追加）

### 即時訊息功能

**使用 Supabase Realtime 實作即時聊天**

### 執行計劃：
- [x] 啟用 Supabase Realtime 功能 ✅ 2025-12-17
- [x] 建立前端 Supabase 客戶端 ✅ 2025-12-17
- [x] 更新聊天頁面支援即時訊息 ✅ 2025-12-17

### V5 實作記錄（2025-12-17）：

**SQL 腳本** (`supabase/enable-realtime.sql`)：
- 啟用 messages 表的 Realtime 功能
- `ALTER PUBLICATION supabase_realtime ADD TABLE messages;`

**前端 Hook** (`src/hooks/useSupabaseClient.ts`)：
- 建立前端專用的 Supabase 客戶端 hook
- 配置 Realtime 參數

**聊天頁面更新** (`src/app/chat/[id]/page.tsx`)：
- 移除 5 秒輪詢機制
- 改用 Supabase Realtime 訂閱 postgres_changes
- 監聯 INSERT 事件，即時收到新訊息
- 樂觀更新：發送訊息立即顯示，不等 API 回應
- 發送失敗時自動移除臨時訊息

編譯測試通過

---

## 新需求 V6（2025-12-17 追加）

### 完成所有剩餘工作項目

### 執行計劃：
- [x] 評價系統功能 ✅ 2025-12-17
- [x] 完整的用戶檔案頁 ✅ 2025-12-17
- [x] 頁尾法律連結 ✅ 2025-12-17

### V6 實作記錄（2025-12-17）：

**評價系統 API** (`src/app/api/reviews/`)：
- `route.ts` - GET: 取得用戶收到的評價列表；POST: 建立新評價
- `can-review/[listingId]/route.ts` - 檢查用戶是否可以評價此刊登
- 評價條件：活動日期已過、申請已被接受、尚未評價過
- 主辦方可評價被接受的申請者，申請者可評價主辦方

**評價系統 UI 元件**：
- `ReviewCard.tsx` - 評價卡片元件，顯示評價者、評分、評論
- `ReviewModal.tsx` - 評價彈窗，支援選擇評價對象、星級評分、評論

**刊登詳情頁更新** (`src/app/listing/[id]/page.tsx`)：
- 新增評價功能：活動結束後顯示評價按鈕
- 自動檢查是否可以評價
- 整合 ReviewModal 元件

**個人檔案頁更新** (`src/app/profile/page.tsx`)：
- 從 API 取得用戶資料和評價
- 新增「收到的評價」區塊
- 顯示用戶頭像（支援自訂頭像）
- 正確顯示評分和評價數

**翻譯更新** (`messages/*.json`)：
- 新增 `review` 區塊，包含所有評價相關翻譯
- 支援繁體中文、簡體中文、日文、英文

**頁尾法律連結** (`src/components/layout/MainLayout.tsx`)：
- 整合 LegalFooter 元件
- 桌面版顯示，行動版透過個人頁面設定存取

編譯測試通過

---

## Bug Fix: 管理員活動不顯示問題（2025-12-17）

### 問題描述
管理員建立的活動無法在前台顯示

### 原因
- Supabase RLS (Row Level Security) 限制
- events 表只允許查看 `is_active = true` 的活動
- INSERT/UPDATE/DELETE 操作需要繞過 RLS

### 解決方案

**更新 Supabase 客戶端** (`src/lib/supabase.ts`)：
- 新增 `supabaseAdmin` 客戶端，使用 `SUPABASE_SERVICE_ROLE_KEY` 繞過 RLS
- 一般操作使用 `supabase`（anon key）
- 管理員操作使用 `supabaseAdmin`（service role key）

**更新 Events API**：
- `GET /api/events`：帶 `includeInactive=true` 時使用 admin client
- `POST /api/events`：使用 admin client
- `PATCH /api/events/[id]`：使用 admin client
- `DELETE /api/events/[id]`：使用 admin client

### 需要的環境變數
```
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
```

可在 Supabase Dashboard → Settings → API 取得 service_role 金鑰

編譯測試通過

---

## 新需求 V7（2025-12-18 追加）

### 用戶編輯/移除自己的刊登功能

**需求描述：**
用戶需要能夠編輯或移除自己發布的刊登

### V7 實作記錄（2025-12-18）：

**AppContext 更新** (`src/contexts/AppContext.tsx`)：
- 新增 `deleteListing` 函數，呼叫 DELETE API 刪除刊登
- 更新 `updateListing` 函數回傳 `Promise<boolean>`

**刊登詳情頁更新** (`src/app/listing/[id]/page.tsx`)：
- 新增主辦方管理選單（三點選單）
- 編輯功能：跳轉至編輯頁面
- 更改狀態功能：選擇 開放中/已配對/已關閉
- 刪除功能：確認彈窗，刪除後跳轉個人頁面

**新增編輯頁面** (`src/app/listing/[id]/edit/page.tsx`)：
- 載入現有刊登資料並填入表單
- 檢查是否為擁有者，非擁有者顯示錯誤
- 表單驗證與提交更新
- 更新成功後跳轉回刊登詳情頁

**翻譯更新** (`messages/*.json`)：
- 在 `listing` 區塊新增：
  - `edit`, `delete`, `changeStatus`
  - `deleteConfirmTitle`, `deleteConfirmMessage`
  - `deleting`, `updating`
  - `statusOpen`, `statusMatched`, `statusClosed`
- 新增 `edit` 區塊：
  - `title`, `updateSuccess`, `updateRedirecting`
  - `update`, `loadingError`, `notFound`
- 支援繁體中文、簡體中文、日文、英文

編譯測試通過

---

## 新需求 V8（2025-12-18 追加）

### 首頁搜索與過濾系統

**需求描述：**
首頁搜索過濾系統，像那種購物電商那種功能，可以很多種過濾
- 模糊關鍵字搜尋(input)
- 活動過濾(下拉式)
- 活動日期區間過濾(選擇)
- 票種類型過濾(下拉式)
- 票券等級(下拉式)
- 價格過濾(兩個輸入框，最低到最高)
- 使用者名稱(input，模糊)
- 評分(下拉式)
- 國籍(下拉式)
- 語言(多選checkbox)
- 把近期活動那個區塊移除

### V8 首頁搜索過濾實作記錄（2025-12-18）：

**首頁更新** (`src/app/page.tsx`)：
- 移除「近期活動」區塊
- 新增完整搜索過濾系統
- 模糊關鍵字搜尋
- 活動下拉式篩選
- 日期範圍篩選（全部/一週內/一個月內/三個月內）
- 票券類型篩選
- 價格範圍篩選（最低/最高）
- 主辦人名稱模糊搜尋
- 最低評分篩選
- 國籍篩選
- 語言多選篩選
- 排序選項（日期/價格/評分）
- 一鍵清除所有篩選

**翻譯更新** (`messages/*.json`)：
- 新增 `filter` 區塊，包含所有過濾相關翻譯
- 支援繁體中文、簡體中文、日文、英文

編譯測試通過

---

## 新需求 V9（2025-12-18 追加）

### 完整需求記錄：

1. 管理員新增的票種等級從下拉式改成輸入框
2. 承上，使用者在選擇票種等級的時候則依照相同名稱的同一按鈕類別，不同名稱的就自動有第二個按鈕
3. 使用者的刊登類型沒有其他語言的翻譯請補上
4. 使用者的刊登類型增加一個叫做換票
5. 一旦選擇換票，就會多出一個欄位要選擇想換的內容:
   - 活動
   - 票種等級(除了既有的設定票種以外額外會有一個任意)
6. 如果選擇換票，希望價格的欄位會隱藏，會有新的欄位
   - 補貼價格（輸入框、不得超過該票券設定票種價格的的一半）
   - 補貼設定 (下拉式，我補貼你、還是你補貼我)
7. 同行集合地點 改名稱為 同行集合地點(線上交換請直接寫線上)
8. 全部完成後檢查所有介面，以中文的介面為準去尋找還有沒有沒翻譯到的文字
9. 全部寫完後，將母票轉讓的功能暫時灰掉不給選擇
10. spec coding

### 執行計劃：
- [x] 管理員票種等級改為輸入框
- [x] 使用者票種等級動態按鈕顯示
- [x] 刊登類型多語言翻譯補充
- [x] 新增換票刊登類型
- [x] 換票欄位邏輯實作
- [x] 同行集合地點改名
- [x] 母票轉讓灰掉禁用
- [x] 測試並部署

### V9 實作記錄（2025-12-18）：

**類型定義更新** (`src/types/index.ts`)：
- `SeatGrade` 從固定值改為動態字串 `string`
- 新增 `ticket_exchange` 票券類型
- 新增 `SubsidyDirection` 類型（'i_pay_you' | 'you_pay_me'）
- `Listing` 介面新增換票欄位：
  - `exchangeEventName`: 想換的活動名稱
  - `exchangeSeatGrade`: 想換的座位等級
  - `subsidyAmount`: 補貼金額
  - `subsidyDirection`: 補貼方向
- `TICKET_TYPE_INFO` 新增 `disabled` 屬性（母票轉讓暫停用）
- 新增 `getSeatGradeLabel()` 和 `getSeatGradeColor()` 函數

**管理員活動表單** (`src/components/admin/EventForm.tsx`)：
- 座位等級從下拉式選單改為輸入框
- 管理員可自訂任意座位等級名稱
- 更新驗證邏輯確保座位等級名稱不為空

**發布頁面** (`src/app/create/page.tsx`)：
- 座位等級改為動態按鈕（根據活動設定自動生成）
- 新增換票類型選項和相關UI
- 換票模式下隱藏價格欄位，顯示：
  - 想換的活動（下拉選擇）
  - 想換的票種等級（動態按鈕 + 任意選項）
  - 補貼金額（限制為票價一半）
  - 補貼方向（我補貼對方/對方補貼我）
- 母票轉讓選項灰掉並顯示「即將開放」標籤
- 同行集合地點標籤改為「同行集合地點（線上交換請直接寫線上）」

**探索頁面** (`src/app/explore/page.tsx`)：
- 新增 ticket_exchange 類型支援

**標籤元件** (`src/components/ui/Tag.tsx`)：
- 新增 ticket_exchange 類型和對應的橘色樣式

**AppContext** (`src/contexts/AppContext.tsx`)：
- 更新 `ApiListing` 介面支援換票欄位
- 更新 `CreateListingData` 介面支援換票欄位
- 轉換函數包含換票欄位

**API 路由** (`src/app/api/listings/route.ts`)：
- POST 路由支援換票相關欄位儲存

**翻譯更新** (`messages/*.json`)：
- 新增 `create.ticketTypes` 區塊（四種語言完整翻譯）
- 新增換票相關翻譯鍵：
  - `exchangeSection`, `exchangeEvent`, `selectExchangeEvent`
  - `exchangeSeatGrade`, `anyGrade`
  - `subsidyAmount`, `subsidyAmountPlaceholder`, `subsidyAmountHint`
  - `subsidyDirection`, `iPayYou`, `youPayMe`
  - `meetingPointWithHint`
- 新增 `ticketType.ticketExchange` 相關翻譯
- 新增 `comingSoon` 翻譯

編譯測試通過

### V9 後續優化（2025-12-18）：

**資料庫 Schema 更新** (`supabase/add-exchange-fields.sql`)：
- 新增 `exchange_event_name` 欄位（想換的活動名稱）
- 新增 `exchange_seat_grade` 欄位（想換的座位等級）
- 新增 `subsidy_amount` 欄位（補貼金額）
- 新增 `subsidy_direction` 欄位（補貼方向）
- 擴充 `seat_grade` 欄位為 VARCHAR(50) 支援自訂名稱
- 新增 `ticket_type` 索引

**刊登詳情頁更新** (`src/app/listing/[id]/page.tsx`)：
- 新增換票資訊顯示區塊（想換活動、票種、補貼資訊）
- 新增零手續費聲明區塊（綠色背景，Shield 圖示）
- 更新 getTicketTypeInfo 支援 ticket_exchange 類型

**翻譯更新** (`messages/*.json`)：
- 新增 `listing.exchangeInfo`、`wantToExchange`、`wantSeatGrade`、`subsidyInfo`、`myTicketPrice`
- 新增 `listing.noFeeTitle`、`noFeeDesc`（零手續費聲明）
- 新增 `common.publishFailed`、`applyFailed`、`deleteFailed`、`updateFailed`
- 新增 `common.defaultUser`、`inputMessage`、`chatWith`、`chat`
- 四語言完整翻譯（繁中/簡中/英文/日文）

**程式碼翻譯化**：
- `create/page.tsx` - alert 錯誤訊息改用翻譯
- `listing/[id]/page.tsx` - alert 錯誤訊息改用翻譯
- `listing/[id]/edit/page.tsx` - alert 錯誤訊息改用翻譯
- `chat/[id]/page.tsx` - 標題和 placeholder 改用翻譯
- `profile/page.tsx` - 預設用戶名改用翻譯

編譯測試通過

---

## 部署步驟：Supabase 資料庫更新

### 執行換票欄位 Migration

**步驟 1：登入 Supabase Dashboard**
1. 前往 https://supabase.com/dashboard
2. 選擇你的專案

**步驟 2：開啟 SQL Editor**
1. 左側選單點擊 **SQL Editor**
2. 點擊 **+ New query** 建立新查詢

**步驟 3：貼上並執行以下 SQL**

```sql
-- Add exchange-related fields to listings table for V9 ticket exchange feature
-- Run this migration to add support for ticket exchange listings

-- Add exchange event name (the event user wants to exchange for)
ALTER TABLE listings ADD COLUMN IF NOT EXISTS exchange_event_name VARCHAR(255);

-- Add exchange seat grade (the seat grade user wants, or 'any')
ALTER TABLE listings ADD COLUMN IF NOT EXISTS exchange_seat_grade VARCHAR(50);

-- Add subsidy amount (max half of original ticket price)
ALTER TABLE listings ADD COLUMN IF NOT EXISTS subsidy_amount INTEGER DEFAULT 0;

-- Add subsidy direction ('i_pay_you' or 'you_pay_me')
ALTER TABLE listings ADD COLUMN IF NOT EXISTS subsidy_direction VARCHAR(20);

-- Update ticket_type column comment to include new type
COMMENT ON COLUMN listings.ticket_type IS 'Ticket type: find_companion, main_ticket_transfer, sub_ticket_transfer, ticket_exchange';

-- Update seat_grade column to allow any string (not just B/A/S/SS)
-- Already VARCHAR(10), but let's expand it for custom grades
ALTER TABLE listings ALTER COLUMN seat_grade TYPE VARCHAR(50);

-- Add index for ticket_type to improve filtering performance
CREATE INDEX IF NOT EXISTS idx_listings_ticket_type ON listings(ticket_type);
```

**步驟 4：執行查詢**
1. 點擊右下角的 **Run** 按鈕（或按 Ctrl+Enter）
2. 確認執行成功，應該會看到 "Success. No rows returned"

**步驟 5：驗證欄位已新增**
在 SQL Editor 執行以下查詢確認：
```sql
SELECT column_name, data_type, character_maximum_length
FROM information_schema.columns
WHERE table_name = 'listings'
AND column_name IN ('exchange_event_name', 'exchange_seat_grade', 'subsidy_amount', 'subsidy_direction', 'seat_grade');
```

應該會看到 5 筆結果，確認欄位已成功建立。

---

## 新需求 V10（2025-12-19 追加）

### 完整需求記錄：

1. 由於首頁的過濾功能很完整，直接移除整個探索頁面跟功能，記得要調整UI，包含所有平台
2. 個人自己發布的活動到現在依然不能編輯跟移除，請將這兩個功能跟管理申請並列
   - [管理申請][編輯活動][移除活動]
3. 點擊編輯活動的時候要警告編輯活動完畢會移除所有申請人，同時被移除申請活動的申請人會在消息那邊收到通知
4. 已經確認要跟誰處理交換的就不能編輯
5. 連結帳號的兩個應該要像其他網站一樣真的連接，點擊後會跳到認證網頁這樣才對
6. 個人資料那邊不只有我的刊登，還要有我的申請，這個申請可以移除
7. 提供所有介面的 日、夜網頁風格

### 執行計劃：
- [x] 移除探索頁面和相關導航 ✅ 2025-12-19
- [x] 更新所有導航元件（底部導航、側邊導航）✅ 2025-12-19
- [x] 個人刊登頁面新增 [管理申請][編輯活動][移除活動] 按鈕 ✅ 2025-12-19
- [x] 編輯活動警告機制（會移除所有申請人）✅ 2025-12-19
- [x] 申請人被移除時發送通知（需先執行 notifications 資料表 SQL）✅ 2025-12-19
- [x] 已配對的刊登禁止編輯 ✅ 2025-12-19
- [x] 個人資料新增「我的申請」區塊 ✅ 2025-12-19
- [x] 申請可移除功能 ✅ 2025-12-19
- [x] 深色/淺色主題切換功能 ✅ 2025-12-19
- [x] 更新所有翻譯（zh-TW, zh-CN, en, ja）✅ 2025-12-19
- [ ] LINE/Discord OAuth 真實連結認證（需設定 OAuth 憑證，見下方說明）

### V10 實作記錄（2025-12-19）：

**已刪除檔案：**
- `src/app/explore/` - 移除整個探索頁面

**已更新檔案：**
- `src/components/layout/BottomNav.tsx` - 移除探索導航項目
- `src/components/layout/SideNav.tsx` - 移除探索導航項目
- `src/app/layout.tsx` - 添加 ThemeProvider，深色模式支援
- `src/app/globals.css` - 添加深色模式 CSS 變數和 @custom-variant

**新增檔案：**
- `src/contexts/ThemeContext.tsx` - 主題切換 Context
- `src/components/ui/ThemeSwitcher.tsx` - 主題切換元件
- `supabase/add-notifications-table.sql` - 通知資料表 SQL

**大幅更新檔案：**
- `src/app/profile/page.tsx` - 新增：
  - 我的申請區塊（顯示所有已申請的刊登）
  - 申請撤回功能（pending 狀態可撤回）
  - 刊登管理按鈕（[管理申請][編輯活動][移除活動]）
  - 主題切換入口
  - 深色模式支援

- `src/app/listing/[id]/edit/page.tsx` - 新增：
  - 編輯警告 Modal（提醒會移除所有申請人）
  - 已配對刊登禁止編輯
  - 獲取申請人數量
  - 深色模式支援

- `src/app/api/listings/[id]/route.ts` - 新增：
  - 已配對刊登禁止編輯檢查
  - 編輯時移除所有申請人
  - 為被移除的申請人創建通知

**翻譯更新** (`messages/*.json`)：
- 新增 `theme` 區塊（主題相關翻譯）
- 更新 `profile` 區塊（新增我的申請、撤回相關）
- 更新 `edit` 區塊（新增警告、配對鎖定相關）
- 更新 `profileSettings` 區塊（OAuth 連結相關）
- 四語言完整翻譯（繁中/簡中/英文/日文）

### 待執行的 SQL：

需在 Supabase SQL Editor 執行 `supabase/add-notifications-table.sql` 來創建通知資料表。

### LINE/Discord OAuth 設定說明：

要讓 LINE/Discord 連結帳號功能真正連接到 OAuth，需要：
1. 在 LINE Developers Console 創建 Channel
2. 在 Discord Developer Portal 創建 Application
3. 設定 `.env.local` 中的 OAuth 憑證
4. 更新 NextAuth 設定以支援帳號連結

目前帳號設定頁面允許用戶手動輸入 LINE ID / Discord 用戶名，這是最簡單的方式。
完整 OAuth 連結功能需要更多後端設定。

編譯測試通過

---
